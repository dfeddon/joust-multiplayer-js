"use strict";function clamp(value,min,max){return Math.max(min,Math.min(value,max))}function getplayers(){this.allplayers=[]}function egyptian_set(){}function game_player(player_instance,isHost,pindex,config){return this.instance=player_instance,this.config=config,this.isBot=!1,this.player_abilities_enabled=!1,this.lpos=this.pos,this.size={x:64,y:64,hx:64,hy:64},this.hitbox={w:32,h:32},this.dir=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.m=.1,this.a=0,this.thrust=.0625,this.thrustModifier=0,this.flap=!1,this.landed=1,this.supportingPlatformId="none",this.tmd=null,this.nw=0,this.sw=0,this.ne=0,this.se=0,this.e=0,this.w=0,this.n=0,this.s=0,this.c=0,this.visible=!0,this.active=!1,this.state="not-connected",this.info_color="rgba(255,255,255,0.1)",this.engaged=!1,this.vuln=!1,this.bubble=!1,this.dying=!1,this.isLocal=!1,this.bufferIndex=void 0,isHost&&player_instance?(this.mp="hp",this.mis="his"):(this.mp="cp"+pindex,this.mis="cis"+pindex),this.inputs=[],this.pos_limits={x_min:0,x_max:this.config.world.width-this.size.hx,y_min:0,y_max:this.config.world.height-this.size.hy},this.pos={x:0,y:0},this.old_state={pos:this.pos},this.cur_state={pos:this.pos},this.state_time=(new Date).getTime(),this.team=0,this.level=1,this.mana=0,this.pointsTotal=0,this.levels=[0,50,100,512,1024,2048,4096,8196,16392,32784,65568,131136],this.progression=0,this.abilities=[],this.abilities.push({label:"burst",id:1,cd:5e3,t:0}),this.ability=0,this.abil=1,this.buffs=[],this.debuffs=[],this.potions=[],this.cooldown=!1,this.hasHelment=!1,this.hasFlag=0,this.flagTakenAt=0,this.disconnected=!1,this.playerName="",void(this.playerSprite="roundRooster")}function game_flag(data,context,getplayers,config){switch(this.getplayers=getplayers,this.config=config,this.id="flg"+data.id,this.name=data.name,this.x=parseInt(data.x),this.y=parseInt(data.y),this.width=64,this.height=64,this.type=data.type?data.type:"flag",this.visible=!0,this.isHeld=!1,this.isPlanted=!0,this.isActive="flag"==this.type,this.validHolder=void 0,this.heldBy=null,this.timer="",this.onCooldown=!1,data.name){case"midFlag":this.sourceSlot="midSlot";break;case"redFlag":this.sourceSlot="slotRed";break;case"blueFlag":this.sourceSlot="slotBlue"}if(this.ctx=context,context)switch(data.name){case"midFlag":this.image=assets.flag_mid_r;break;case"redFlag":this.image=assets.flag_red_l;break;case"blueFlag":this.image=assets.flag_blue_r;break;case"slot1":this.image=assets.flag_slot_1;break;case"slot2":this.image=assets.flag_slot_2;break;case"slot3":this.image=assets.flag_slot_3;break;case"slot4":this.image=assets.flag_slot_4;break;case"slot5":this.image=assets.flag_slot_5;break;case"slot6":this.image=assets.flag_slot_6;break;case"slot7":this.image=assets.flag_slot_7;break;case"slot8":this.image=assets.flag_slot_8;break;case"slot9":this.image=assets.flag_slot_9;break;case"slot10":this.image=assets.flag_slot_10;break;case"slotBlue":this.image=assets.flag_slot_blue;break;case"slotRed":this.image=assets.flag_slot_red;break;case"midSlot":this.image=assets.flag_slot_mid}}function game_platform(game_instance,client){this.STATE_REMOVED=0,this.STATE_INTACT=1,this.STATE_FALLING=2,this.STATE_DESTROYED=3,this.STATE_ROTATING=4,this.STATE_SHAKING=5,this.STATUS_ROTATING=4,this.TO_RADIANS=Math.PI/180,this.game=game_instance,this.client=client,this.client&&(this.ctx=game_instance.canvasPlatforms.getContext("2d")),this.id="noid",this.x=0,this.y=0,this.w=0,this.h=0,this.old={x:this.x,y:this.y,w:this.w,h:this.h},this.spawn=null,this.layout="h",this.type=1,this.status=1,this.triggerer=null}function game_event(getplayers,config){this.getplayers=getplayers,this.config=config,this.shuffle=require("./node_modules/lodash/shuffle"),this.TYPE_CHEST=1,this.TYPE_FLAG_CARRIED_COOLDOWN=2,this.TYPE_FLAG_SLOTTED_COOLDOWN=3,this.COOLDOWN_FLAG_CARRIED=60,this.COOLDOWN_FLAG_SLOTTED=15,this.STATE_RUNNING=1,this.STATE_PAUSED=2,this.STATE_COMPLETE=3,this.STATE_AVAILABLE=4,this.STATE_STOPPED=5,this.STATE_EVENT_READY=6,this.STATE_EVENT_QUEUED=7,this.id="noid",this.type=NaN,this.running=!1,this.state=this.STATE_AVAILABLE,this.repeatable=!0,this.timer=NaN,this.lastTimer=NaN,this.rangeMin=0,this.rangeMax=0,this.triggeredAt=null,this.triggerOn=null,this.triggerer=null,this.dif=void 0,this.spawn=null,this.passive=null,this.flag=null}function game_chest(data,client,getplayers,config){if(this.data=data,this.getplayers=getplayers,this.config=config,client){var v=document.getElementById("viewport");this.ctx=v.getContext("2d")}this.id=data.i,this.x=parseInt(data.x),this.y=parseInt(data.y),this.type=data.t,this.duration=data.d,this.modifier=data.m,this.data=data,this.width=64,this.height=64,this.taken=!1,this.takenBy=null,this.opening=!1}function game_toast(){this.toast=document.getElementById("toast")}var gameport=process.env.PORT||4004,io=require("socket.io"),clientIo=require("socket.io-client"),express=require("express"),UUID=require("node-uuid"),debug=require("debug"),winston=require("winston"),verbose=!1,http=require("http"),app=express(),server=http.createServer(app),util=require("util"),WORKERS=process.env.WEB_CONCURRENCY||1;server.listen(gameport),app.get("/",function(req,res){res.sendfile("/index.html",{root:__dirname})}),app.get("/*",function(req,res,next){var file=req.params[0];res.sendfile(__dirname+"/"+file)}),app.post("/api/orbs",function(req,res,next){return res.send("hi",game_server.games.length)}),app.post("/api/playernames",function(req,res,next){});var sio=io.listen(server);sio.engine.ws=new(require("uws").Server)({noServer:!0,perMessageDeflate:!1}),sio.use(function(socket,next){socket.request;next()});var game_server=require("./game.server.js");sio.sockets.on("connection",function(client){client.userid=UUID(),client.emit("onconnected",{id:client.userid}),game_server.findGame(client),client.on("message",function(m){game_server.onMessage(client,m)}),client.on("disconnect",function(){client.game&&client.game.id&&game_server.endGame(client.gameid,client.userid)})});var host=clientIo.connect(UUID());host.userid=UUID(),host.hosting=!0,game_server.createGame(host);var MAX_PLAYERS_PER_GAME=30,game_server=module.exports={games:{},game_count:0},UUID=require("node-uuid"),name_set=require("./egyptian_set"),verbose=!0;global.window=global.document=global,require("./game.core.js"),game_server.log=function(){},game_server.fake_latency=0,game_server.local_time=0,game_server._dt=(new Date).getTime(),game_server._dte=(new Date).getTime(),game_server.messages=[],setInterval(function(){game_server._dt=(new Date).getTime()-game_server._dte,game_server._dte=(new Date).getTime(),game_server.local_time+=game_server._dt/1e3},4),game_server.onMessage=function(client,message){this.fake_latency&&"i"==message.split(".")[0].substr(0,1)?(game_server.messages.push({client:client,message:message}),setTimeout(function(){game_server.messages.length&&(game_server._onMessage(game_server.messages[0].client,game_server.messages[0].message),game_server.messages.splice(0,1))}.bind(this),this.fake_latency)):game_server._onMessage(client,message)},game_server._onMessage=function(client,message){var message_parts=message.split("."),message_type=message_parts[0];if("i"==message_type)this.onInput(client,message_parts);else if("p"==message_type)client.send("s.p."+message_parts[1]);else if("c"==message_type){for(var other_clients=[],i=0;i<client.game.player_clients.length;i++)client.game.player_clients[i].userid!=client.userid&&other_clients.push(client.game.player_clients[i]);if(other_clients.length>0)for(var j=0;j<other_clients.length;j++)other_clients[j].send("s.c"+message_parts[1])}else if("l"==message_type)this.fake_latency=parseFloat(message_parts[1]);else if("n"==message_type){this.log("getting player names for",message_parts[1],"...");for(var p=client.game.gamecore.getplayers.allplayers,arr=[],j=0;j<p.length;j++)p[j].mp!=message_parts[1]&&"hp"!=p[j].mp&&p[j].instance&&arr.push({mp:p[j].mp,name:p[j].playerName,team:p[j].team});this.log(arr);for(var thegame=this.games[message_parts[2]],i=0;i<thegame.player_clients.length;i++)thegame.player_clients[i].mp==message_parts[1]&&(thegame.player_clients[i].send("s.n."+JSON.stringify(arr)),thegame.player_clients.splice(i,1))}},game_server.onInput=function(client,parts){var input_commands=parts[1].split("-"),input_time=parts[2].replace("-","."),input_seq=parts[3];client&&client.game&&client.game.gamecore&&client.game.gamecore.handle_server_input(client,input_commands,input_time,input_seq)},game_server.createGame=function(client){this.log("@@ createGame by HOST id",client.userid),client.hosting=!0;var clients=[];clients.push(client);var thegame={id:UUID(),player_host:client,player_client:null,player_clients:clients,player_count:1};return this.games[thegame.id]=thegame,this.game_count++,thegame.gamecore=new game_core(thegame),thegame.gamecore.update((new Date).getTime()),client.send("s.h."+String(thegame.gamecore.local_time).replace(".","-")),client.game=thegame,client.hosting=!0,this.log("@@ player "+client.userid+" created a game with id "+client.game.id),thegame},game_server.endGame=function(gameid,userid){this.log("@@ endGame",gameid,"for user",userid);var thegame=this.games[gameid];if(thegame){if(this.log("total players",thegame.player_count,"clients",thegame.player_clients.length),thegame.player_count>1){for(var allplayers=thegame.gamecore.getplayers.allplayers,game_instance=this.games[gameid],i=0;i<thegame.player_clients.length;i++)this.log(thegame.player_clients.length,thegame.player_clients[i].userid,userid),thegame.player_clients[i].userid==userid&&(thegame.player_clients[i].send("s.e"),thegame.player_clients.splice(i,1));for(var disconnected_mp,j=0;j<allplayers.length;j++)allplayers[j].id==userid&&(disconnected_mp=allplayers[j].mp,allplayers[j].host||(allplayers[j].instance=null),allplayers[j].active=!1,allplayers[j].pos={x:0,y:0},game_instance.player_count--);if(disconnected_mp)for(var k=0;k<allplayers.length;k++)allplayers[k].mp!=disconnected_mp&&"hp"!=allplayers[k].mp&&allplayers[k].instance&&(allplayers[k].instance.send("s.e."+disconnected_mp),thegame.gamecore.players.self=allplayers[k])}}else this.log("@@ that game was not found!")},game_server.startGame=function(game,newplayer){this.log("@@ startGame",game.id,newplayer.mp,newplayer.userid),this.log("* total clients",game.player_clients.length);for(var newplayerInstance,playerName,playerMP,team,host,p=game.gamecore.getplayers.allplayers,nonhosts=[],x=0;x<p.length;x++)p[x].mp==newplayer.mp?(this.log("* found server newplayer instance",p[x].playerName),p[x].instance.gameid=game.id,p[x].active=!0,p[x].visible=!0,p[x].dead=!1,p[x].vuln=!1,p[x].landed=0,newplayerInstance=p[x],playerName=p[x].playerName,playerMP=p[x].mp,team=Math.floor(2*Math.random())+1,newplayerInstance.team=team,nonhosts.push(p[x].instance)):p[x].instance&&p[x].instance.hosting?(this.log("* found host",p[x].mp),host=p[x].instance):p[x].instance&&nonhosts.push(p[x].instance);var game_instance=this.games[game.id];if(host)for(var j=0;j<nonhosts.length;j++){this.log("@@",nonhosts[j].userid,nonhosts[j].mp,nonhosts.pos);for(var playerName,playerMP,p=game_instance.gamecore.getplayers.allplayers,x=0;x<p.length;x++)p[x].mp==nonhosts[j].mp?this.log("* found server player instance",p[x].playerName):this.log(x,p[x].mp,p[x].playerName);for(var chest,obj,chestsarray=[],k=0;k<game_instance.gamecore.chests.length;k++)chest=game_instance.gamecore.chests[k],obj={i:chest.data.i,d:chest.data.d,m:chest.data.m,t:chest.data.t,x:chest.data.x,y:chest.data.y},chestsarray.push(obj);for(var flag,flagsArray=[],fo=game_instance.gamecore.config.flagObjects,l=0;l<fo.length;l++)"flag"==fo[l].type&&(flag={name:fo[l].name,x:fo[l].x,y:fo[l].y,visible:fo[l].visible},flagsArray.push(flag));nonhosts[j].mp!=newplayer.mp?(this.log("* sending joingame event to",nonhosts[j].mp),this.log("* data:",playerMP,playerName),nonhosts[j].send("s.j."+playerMP+"|"+this.games[game.id].id+"|"+JSON.stringify(chestsarray)+"|"+team+"|"+playerName+"|"+JSON.stringify(flagsArray))):(this.log("* sending MYgame event to",nonhosts[j].mp),this.log("* data:",playerMP,playerName),nonhosts[j].send("s.h."+playerMP+"|"+this.games[game.id].id+"|"+JSON.stringify(chestsarray)+"|"+team+"|"+playerName+"|"+JSON.stringify(flagsArray))),nonhosts[j].game=game}for(var k=0;k<nonhosts.length;k++)this.log("readyup!",nonhosts[k].userid),nonhosts[k].send("s.r."+String(game.gamecore.local_time).replace(".","-"));game.active=!0},game_server.findGame=function(client){if(this.log("@@ findGame",client.userid,"looking for a game. We have : "+this.game_count),this.game_count){var joined_a_game=!1;for(var gameid in this.games)if(this.games.hasOwnProperty(gameid)){var game_instance=this.games[gameid];if(this.log("@@ player count",game_instance.player_count,"of",MAX_PLAYERS_PER_GAME),game_instance.player_count<MAX_PLAYERS_PER_GAME){joined_a_game=!0,game_instance.player_clients.push(client),this.log("@@ assigning client to MY (other, client-based) player instance!");var players,client_added=!1;this.log("@@ total clients",game_instance.player_clients.length);for(var j=0;j<game_instance.player_clients.length;j++){players=game_instance.gamecore.getplayers.allplayers;for(var i=0;i<players.length;i++)if(!players[i].instance&&client_added===!1){players[i].instance=client,players[i].id=client.userid,players[i].isLocal=!0;var teamRed_x=6,teamRed_y=6,sx=Math.floor(Math.random()*teamRed_x)+1,sy=Math.floor(Math.random()*teamRed_y)+1;players[i].pos=game_instance.gamecore.gridToPixel(sx,sy),players[i].gameid=gameid,client.mp=players[i].mp,client_added=!0}}this.log("@@ allplayers num",players.length),game_instance.player_count++,this.startGame(game_instance,client)}}joined_a_game||this.createGame(client)}else this.createGame(client)};var _=require("./node_modules/lodash/lodash.min"),UUID=require("node-uuid"),config=require("./class.globals"),getplayers=require("./class.getplayers"),egyptian_set=require("./egyptian_set"),game_player=require("./class.player"),game_flag=require("./class.flag"),platformClass=require("./class.platform"),game_event_server=require("./class.event"),game_chest=require("./class.chest"),assets=require("./singleton.assets"),game_toast=require("./class.toast"),glog=!1,frame_time=.06;"undefined"!=typeof global&&(frame_time=45),function(){for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currTime=Date.now(),timeToCall=Math.max(0,frame_time-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}();var game_core=function(game_instance){this.instance=game_instance,this.server=void 0!==this.instance,this.getplayers=new getplayers,this.config=new config;this.bg=null,this.fg=null,this.barriers=null,this.inputDelay=!1;var worldWidth=3200,worldHeight=2368;if(this.config.world={width:worldWidth,height:worldHeight},this.config.world.gravity=.05,this.config.world.totalplayers=30,this.config.world.maxOrbs=0,this.orbs=[],this.tilemap=null,this.config.tilemapData=null,this.chestSpawnPoints=[],this.config.flagObjects=[],this.clientCooldowns=[{name:"redFlag",heldBy:null,timer:NaN,src:null,target:null},{name:"blueFlag",heldBy:null,timer:NaN,src:null,target:null},{name:"midFlag",heldBy:null,timer:NaN,src:null,target:null}],this.cam={x:0,y:0},this.mp=null,this.gameid=null,this.getplayers.allplayers=[],this.player_abilities_enabled=!1,this.spritesheets=[],this.spritesheetsData=[],this.events=[],this.passives=[{id:"pass1",type:1,name:"acceleration",duration:60,modifier:50},{id:"pass2",type:2,name:"bubble",duration:45,modifier:1}],this.chests=[],this.server){this.apiNode();for(var other,i=1;i<this.config.world.totalplayers;i++)other=new game_player(null,!1,this.getplayers.allplayers.length+1,this.config),other.pos=this.gridToPixel(i,0),other.playerName=this.nameGenerator(),this.getplayers.allplayers.push(other);var hp=new game_player(this.instance.player_host,!0,NaN,this.config);this.getplayers.allplayers.push(hp),this.players={},this.players.self=hp;for(var j in this.getplayers.allplayers);var evt=new game_event_server(this.getplayers,this.config);evt.type=evt.TYPE_CHEST,evt.id="ec",evt.setRandomTriggerTime(25,45),this.events.push(evt),evt=new game_event_server(this.getplayers,this.config),evt.type=evt.TYPE_FLAG_CARRIED_COOLDOWN,evt.state=evt.STATE_STOPPED,evt.id="fc",evt.repeatable=!1,this.events.push(evt),evt=new game_event_server(this.getplayers,this.config),evt.type=evt.TYPE_FLAG_SLOTTED_COOLDOWN,evt.state=evt.STATE_STOPPED,evt.id="fs",evt.repeatable=!1,this.events.push(evt)}else{this.flashBang=0,this.api(),this.players={};for(var p,l=1;l<this.config.world.totalplayers;l++)p=new game_player(null,!1,this.getplayers.allplayers.length+1,this.config),p.pos=this.gridToPixel(l,0),this.getplayers.allplayers.push(p);var chost=new game_player(null,!1,NaN,this.config);chost.mp="hp",chost.mis="his",chost.host=!0,this.getplayers.allplayers.push(chost),this.players.self=chost;for(var y in this.getplayers.allplayers);}if(this.playerspeed=500,this._pdt=1e-4,this._pdte=(new Date).getTime(),this.local_time=.016,this._dt=(new Date).getTime(),this._dte=(new Date).getTime(),this.create_physics_simulation(),this.create_timer(),this.server?(this.config.server_time=0,this.laststate={}):(this.keyboard=new THREEx.KeyboardState,this.config.keyboard=new THREEx.KeyboardState,this.client_create_configuration(),this.server_updates=[],this.client_connect_to_server(),this.client_create_ping_timer(),this.color=localStorage.getItem("color")||"#cc8822",localStorage.setItem("color",this.color),this.players.self.color=this.color,String(window.location).indexOf("debug")!=-1&&this.client_create_debug_gui()),!this.server){var v=document.getElementById("viewport");this.config.ctx=v.getContext("2d")}this.config.server=!!this.server,this.config.keyboard=this.keyboard,this.config.updateTerritory=this.updateTerritory,this.config.flagToScore=this.flagToScore,this.config.players=this.players,this.config.events=this.events,this.config.clientCooldowns=this.clientCooldowns,this.config.chests=this.chests,this.config.chestSpawnPoints=this.chestSpawnPoints,this.config.passives=this.passives,this.config._=_,this.config.gridToPixel=this.gridToPixel};"undefined"!=typeof global&&(module.exports=global.game_core=game_core),game_core.prototype.getKeyboard=function(){return this.keyboard},game_core.prototype.nameGenerator=function(){var egyptian_set;egyptian_set=require("./egyptian_set");var set=(new egyptian_set).getSet(),rnd=Math.floor(Math.random()*set.length),pname=set[rnd];return pname},game_core.prototype.api=function(){var self=this,xmlhttp=new XMLHttpRequest,url="./assets/tilemaps/joust-alpha-1.tmx";xmlhttp.open("GET",url,!0),xmlhttp.setRequestHeader("Content-type","application/json"),xmlhttp.setRequestHeader("X-Parse-Application-Id","VnxVYV8ndyp6hE7FlPxBdXdhxTCmxX1111111"),xmlhttp.setRequestHeader("X-Parse-REST-API-Key","6QzJ0FRSPIhXbEziFFPs7JvH1l11111111"),xmlhttp.send(""),xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&(self.tilemap=xmlhttp.responseText,self.tilemapper(),self.prerenderer())}},game_core.prototype.buildPlatforms=function(){},game_core.prototype.addTouchHandlers=function(){function handleStart(e){switch(e){case"dirL":document.externalControlAction("A");break;case"dirR":document.externalControlAction("D");break;case"flap":document.externalControlAction("u")}}function handleEnd(e){switch(e){case"dirL":document.externalControlAction("B");break;case"dirR":document.externalControlAction("E");break;case"flap":document.externalControlAction("x")}}var dirL=(document.getElementById("viewport"),document.getElementById("dirL")),dirR=document.getElementById("dirR"),dirF=document.getElementById("flap"),dl=new Hammer(dirL),dr=new Hammer(dirR),flap=new Hammer(dirF);dl.on("press",function(e){handleStart("dirL")}),dl.on("pressup",function(e){handleEnd("dirL")}),dr.on("press",function(e){handleStart("dirR")}),dr.on("pressup",function(e){handleEnd("dirR")}),flap.on("press",function(e){handleStart("flap")}),flap.on("pressup",function(e){handleEnd("flap")})},game_core.prototype.apiNode=function(){var _this=this,xml2js=require("xml2js"),fs=require("fs"),parser=new xml2js.Parser({explicitArray:!1});fs.readFile("./assets/tilemaps/joust-alpha-1.tmx",function(err,data){parser.parseString(data,function(err,result){for(var split2,data=JSON.stringify(result.map.layer[1].data._),split=data.split("\\n"),base=[],len=split.length,i=1;i<len-1;i++)split2=split[i].split(","),split2.pop(),base.push(split2);_this.config.tilemapData=base;for(var node,builder=new xml2js.Builder,objectgroupNode=(builder.buildObject(result.map.objectgroup),result.map.objectgroup),j=0;j<objectgroupNode.length;j++)switch(node=objectgroupNode[j],objectgroupNode[j].$.name){case"chestSpawn":if(void 0===objectgroupNode[j].object.length)_this.chestSpawnPoints.push(objectgroupNode[j].object);else for(var k=0;k<objectgroupNode[j].object.length;k++)_this.chestSpawnPoints.push(objectgroupNode[j].object[k].$);break;case"flagObjects":var flag;if(void 0===objectgroupNode[j].object.length)flag=new game_flag(objectgroupNode[j].object.$,null,this.getplayers,this.config),this.config.flagObjects.push(flag);else for(var l=0;l<objectgroupNode[j].object.length;l++)flag=new game_flag(objectgroupNode[j].object[l].$,null,_this.getplayers,_this.config),flag.id="flg"+l.toString(),_this.config.flagObjects.push(flag)}})})},Number.prototype.fixed=function(n){return n=n||3,parseFloat(this.toFixed(n))},game_core.prototype.pos=function(a){return{x:a.x,y:a.y}},game_core.prototype.v_add=function(a,b){return{x:(a.x+b.x).fixed(),y:(a.y+b.y).fixed()}},game_core.prototype.v_sub=function(a,b){return{x:(a.x-b.x).fixed(),y:(a.y-b.y).fixed()}},game_core.prototype.v_mul_scalar=function(a,b){return{x:(a.x*b).fixed(),y:(a.y*b).fixed()}},game_core.prototype.stop_update=function(){window.cancelAnimationFrame(this.updateid)},game_core.prototype.lerp=function(p,n,t){var _t=Number(t);return _t=Math.max(0,Math.min(1,_t)).fixed(),(p+_t*(n-p)).fixed()},game_core.prototype.v_lerp=function(v,tv,t){return{x:this.lerp(v.x,tv.x,t),y:this.lerp(v.y,tv.y,t),d:tv.d}},game_core.prototype.gridToPixel=function(x,y){return{x:64*x,y:64*y}},game_core.prototype.getUID=function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()},game_core.prototype.updateTerritory=function(){function pixelToBrick(x){return Math.floor(x/(brickWidth+brickPadding))}null==this.config.bg&&(this.bg=document.createElement("canvas"),this.bg.id="bg",this.bg.x=0,this.bg.y=0,this.bg.width=this.config.world.width,this.bg.height=this.config.world.height,this.config.bg=this.bg);for(var ctx=this.bg.getContext("2d"),brickWidth=30,brickHeight=15,brickPadding=1,brickOffsetTop=0,brickOffsetLeft=0,brickColumnCount=this.config.world.width/(brickWidth+brickPadding),brickRowCount=this.config.world.height/(brickHeight+brickPadding),bricks=[],c=0;c<brickColumnCount;c++)for(bricks[c]=[],r=0;r<brickRowCount;r++)bricks[c][r]={x:0,y:0};for(var brickX,brickY,red=_.find(this.config.flagObjects,{name:"redFlag"}),mid=_.find(this.config.flagObjects,{name:"midFlag"}),blue=_.find(this.config.flagObjects,{name:"blueFlag"}),redflagX=pixelToBrick(red.x+red.width/2),midflagX=pixelToBrick(mid.x+mid.width/2),blueflagX=pixelToBrick(blue.x+blue.width/2),c=0;c<brickColumnCount;c++)for(var r=0;r<brickRowCount;r++)brickX=c*(brickWidth+brickPadding)+brickOffsetLeft,brickY=r*(brickHeight+brickPadding)+brickOffsetTop,bricks[c][r].x=brickX,bricks[c][r].y=brickY,redflagX>0&&c<=redflagX||c>midflagX&&c<blueflagX?(ctx.beginPath(),ctx.fillStyle="#04293c",ctx.rect(brickX,brickY,brickWidth,brickHeight),ctx.fill(),ctx.closePath()):(ctx.beginPath(),ctx.fillStyle="#340404",ctx.rect(brickX,brickY,brickWidth,brickHeight),ctx.fill(),ctx.closePath());var redSrc=red.sourceSlot,midSrc=mid.sourceSlot,blueSrc=blue.sourceSlot,score2=this.flagToScore(red.name,redSrc),score3=this.flagToScore(mid.name,midSrc),score4=this.flagToScore(blue.name,blueSrc),redRaw=score2.red+score3.red+score4.red,blueRaw=score2.blue+score3.blue+score4.blue,redTotal=Math.abs(score2.red)+Math.abs(score3.red)+Math.abs(score4.red),blueTotal=Math.abs(score2.blue)+Math.abs(score3.blue)+Math.abs(score4.blue),pointsAllocated=10,redScore=parseInt(redTotal/pointsAllocated*100),blueScore=parseInt(blueTotal/pointsAllocated*100);redRaw<0?redScore=-redScore:blueRaw<0&&(blueScore=-blueScore),blueScore+=50,redScore+=50;var redTxt=document.getElementById("txtScoreRed"),blueTxt=document.getElementById("txtScoreBlue");redTxt.innerHTML=redScore+"%",blueTxt.innerHTML=blueScore+"%"},game_core.prototype.flagToScore=function(flag,slot){var red=0,blue=0;switch(slot){case"slotRed":"redFlag"==flag&&(red=0,blue=0);break;case"slotBlue":"redFlag"==flag||"blueFlag"==flag&&(red=0,blue=0);break;case"midSlot":"redFlag"==flag?(red=-5,blue=5):"blueFlag"==flag?(red=5,blue=-5):"midFlag"==flag&&(red=5,blue=5);break;case"slot1":"redFlag"==flag?(red=-1,blue=1):"blueFlag"==flag||"midFlag"==flag&&(red=-4,blue=4);break;case"slot2":"redFlag"==flag?(red=-2,blue=2):"blueFlag"==flag?(red=11,blue=-11):"midFlag"==flag&&(red=-4,blue=4);break;case"slot3":"redFlag"==flag?(red=-3,blue=3):"blueFlag"==flag?(red=10,blue=-10):"midFlag"==flag&&(red=-3,blue=3);break;case"slot4":"redFlag"==flag?(red=-3,blue=3):"blueFlag"==flag?(red=9,blue=-9):"midFlag"==flag&&(red=-2,blue=2);break;case"slot5":"redFlag"==flag?(red=-3,blue=3):"blueFlag"==flag?(red=8,blue=-8):"midFlag"==flag&&(red=-1,blue=1);break;case"slot6":"redFlag"==flag?(red=-7,blue=7):"blueFlag"==flag?(red=5,blue=-5):"midFlag"==flag&&(red=1,blue=-1);break;case"slot7":"redFlag"==flag?(red=-8,blue=8):"blueFlag"==flag?(red=4,blue=-4):"midFlag"==flag&&(red=2,blue=-2);break;case"slot8":"redFlag"==flag?(red=-9,blue=9):"blueFlag"==flag?(red=3,blue=-3):"midFlag"==flag&&(red=3,blue=-3);break;case"slot9":"redFlag"==flag?(red=-10,blue=10):"blueFlag"==flag?(red=2,blue=-2):"midFlag"==flag&&(red=4,blue=-4);break;case"slot10":"redFlag"==flag||("blueFlag"==flag?(red=1,blue=-1):"midFlag"==flag&&(red=5,blue=-5))}return{red:red,blue:blue}},game_core.prototype.tilemapper=function(){var canvas3=document.createElement("canvas");canvas3.id="canvas3",canvas3.x=0,canvas3.y=0,canvas3.width=this.config.world.width,canvas3.height=this.config.world.height;canvas3.getContext("2d");if(this.tilemap){var tileWidth,tileHeight,tileCount,columns,renderOrder,width,height,nextObjectId,_this=this,parser=new DOMParser,xmlDoc=parser.parseFromString(this.tilemap,"text/xml"),mapNode=xmlDoc.getElementsByTagName("map");renderOrder=mapNode[0].getAttribute("renderorder"),width=mapNode[0].getAttribute("width"),height=mapNode[0].getAttribute("height"),tileWidth=mapNode[0].getAttribute("tilewidth"),tileHeight=mapNode[0].getAttribute("tileheight"),nextObjectId=mapNode[0].getAttribute("nextobjectid");var tilesetNode=xmlDoc.getElementsByTagName("tileset");tileCount=tilesetNode[0].getAttribute("tilecount"),columns=tilesetNode[0].getAttribute("columns"),name=tilesetNode[0].getAttribute("name");for(var objectgroupNode=xmlDoc.getElementsByTagName("objectgroup"),flagArray=[],og=0;og<objectgroupNode.length;og++){var ogName=objectgroupNode[og].getAttribute("name"),ogInner=objectgroupNode[og].innerHTML,ogRows=ogInner.split("\n");ogRows.shift(),ogRows.pop();for(var xml,atts,parser=new DOMParser,nodes=[],d=0;d<ogRows.length;d++)xml=parser.parseFromString(ogRows[d],"text/xml"),atts=xml.childNodes[0].attributes,nodes.push(atts);switch(ogName){case"chestSpawn":break;case"flagObjects":var flagObjectsObj;_.forEach(nodes,function(e){flagObjectsObj={},Array.prototype.slice.call(e).forEach(function(item){flagObjectsObj[item.name]=item.value}),flagArray.push(flagObjectsObj)});for(var k in flagObjectsObj)delete flagObjectsObj[k]}}for(var layerName,data,dataNode,layerWidth,layerHeight,layerNode=xmlDoc.getElementsByTagName("layer"),layerData=[],base=[],layersStored=[],x=0;x<layerNode.length;x++){var vis=layerNode[x].getAttribute("visible");if(0!=vis){layerName=layerNode[x].getAttribute("name"),layerWidth=layerNode[x].getAttribute("width"),layerHeight=layerNode[x].getAttribute("height"),dataNode=layerNode[x].getElementsByTagName("data")[0],data=layerNode[x].getElementsByTagName("data")[0].innerHTML,layersStored.push(layerName),base=[];var rows=data.split("\n");rows.shift(),rows.pop();for(var i=0;i<rows.length;i++)rows[i]=rows[i].split(","),i!==rows.length-1&&rows[i].pop(),base.push(rows[i]);"barriers"==layerName&&(this.config.tilemapData=base),layerData.push(base)}}var source,trans,imageWidth,imageHeight,imageNode=xmlDoc.getElementsByTagName("image");source=imageNode[0].getAttribute("source"),trans=imageNode[0].getAttribute("trans"),imageWidth=imageNode[0].getAttribute("width"),imageHeight=imageNode[0].getAttribute("height");var image=assets.skin1_tileset,tilemap=document.createElement("canvas");self.tmCanvas=tilemap,tilemap.id="tilemap",tilemap.width=width*tileWidth,tilemap.height=height*tileHeight;var tmContext=tilemap.getContext("2d");tmContext.drawImage(image,0,0);for(var n,c,cContext,y=0;y<layerData.length;y++){n=layersStored[y],c=document.createElement("canvas"),c.style.cssText="position:absolute;display:block;top:0;left:0",c.zIndex=y+1,self.tmCanvas=tilemap,c.id=n,c.width=width*tileWidth,c.height=height*tileHeight,cContext=c.getContext("2d");for(var tile,t,col,count=0,colMax=imageWidth/tileWidth,j=0;j<layerData[y].length;j++)for(var k=0;k<layerData[y][j].length;k++)t=parseInt(layerData[y][j][k]-1),t>-1&&(col=t%colMax|0,tile=tmContext.getImageData(col*tileWidth,Math.floor(t/colMax)*tileWidth,tileWidth,tileHeight),cContext.putImageData(tile,count%width*tileHeight,Math.floor(count/width)*tileWidth)),count++;_this[c.id]=c}tilemap=null,self.tmCanvas=null,_this.addSpriteSheets();var pre={midFlag:void 0,redFlag:void 0,blueFlag:void 0};if(_this.config.preflags)for(var x=0;x<_this.config.preflags.length;x++)pre[_this.config.preflags[x].name]=_this.config.preflags[x];_.forEach(flagArray,function(fo){if("flag"==fo.type){var flag=new game_flag(fo,_this.viewport.getContext("2d"),_this.getplayers,_this.config);_this.config.preflags&&(flag.visible=pre[fo.name].visible,flag.x=pre[fo.name].x,flag.y=pre[fo.name].y),_this.config.flagObjects.push(flag)}else if("slot"==fo.type){var slot=new game_flag(fo,_this.fg.getContext("2d"),_this.getplayers,_this.config);_this.config.flagObjects.push(slot),slot.draw()}}),_this.updateTerritory()}},game_core.prototype.addSpriteSheets=function(){for(var csprite,p=0;p<this.spritesheetsData.length;p++)csprite=new game_spritesheet(this.ctx),csprite.id=this.spritesheetsData[p].id,csprite.setter({type:this.spritesheetsData[p].type,x:this.spritesheetsData[p].x,y:this.spritesheetsData[p].y,w:this.spritesheetsData[p].w,h:this.spritesheetsData[p].h,frames:this.spritesheetsData[p].frames}),this.spritesheets.push(csprite)},game_core.prototype.prerenderer=function(){var context2,canvas2;this.canvas2?(context2=this.canvas2.getContext("2d"),context2.clearRect(0,0,this.config.world.width,this.config.world.height)):(canvas2=document.createElement("canvas"),canvas2.id="canvas2",canvas2.width=this.config.world.width,canvas2.height=this.config.world.height,context2=canvas2.getContext("2d"));var c,gradient,x,y,size,colors=["pink","lightblue","yellow","green","white","orange"];context2.save(),context2.translate(x,y);for(var orbs=this.orbs,k=0;k<this.orbs.length;k++)size=Math.floor(4*Math.random())+2,c=colors[Math.floor(Math.random()*colors.length)],x=Math.floor(Math.random()*this.config.world.width)+1,y=Math.floor(Math.random()*this.config.world.height)+1,context2.beginPath(),gradient=context2.createRadialGradient(this.orbs[k].x,this.orbs[k].y,0,this.orbs[k].x,this.orbs[k].y,this.orbs[k].w),
gradient.addColorStop(0,"white"),gradient.addColorStop(1,orbs[k].c),context2.fillStyle=gradient,context2.arc(orbs[k].x,orbs[k].y,orbs[k].w,0*Math.PI,2*Math.PI),context2.shadowBlur=10,context2.shadowColor="white",context2.fill(),context2.closePath();context2.restore(),this.canvas2||(this.canvas2=canvas2)},game_core.prototype.update=function(t){this.dt=this.lastframetime?((t-this.lastframetime)/1e3).fixed():.016,this.lastframetime=t,this.server?this.server_update():this.client_update(),this.updateid=window.requestAnimationFrame(this.update.bind(this),this.viewport)},game_core.prototype.pk=function(victor,victim){victim.active=!1,_.forEach(this.getplayers.allplayers,function(p,i){p.instance&&"hp"!=p.mp&&p.instance.send("p.k."+victim.mp+"|"+victor.mp)}),victim.doKill(victor)},game_core.prototype.check_collision=function(player){if("hp"!=player.mp){var _this=this;this.config.server&&_.forEach(this.getplayers.allplayers,function(other){if(other.mp!=player.mp&&other.team!=player.team&&other.active&&player.pos.x+player.size.hx/4<other.pos.x+(other.size.hx-other.size.hx/4)&&player.pos.x+(player.size.hx-player.size.hx/4)>other.pos.x+other.size.hx/4&&player.pos.y+player.size.hy/4<other.pos.y+(other.size.hy-other.size.hy/4)&&player.pos.y+(player.size.hy-player.size.hy/4)>other.pos.y+other.size.hy/4){var dif=player.pos.y-other.pos.y;if(dif>=-5&&dif<=5&&player.vuln===!1&&other.vuln===!1||player.vuln===!0&&other.vuln===!0){_this.flashBang=1;player.hitFrom=3,player.collision=!0,player.target=other,other.hitFrom=3,other.collision=!0,other.target=player}else player.pos.y<other.pos.y||other.vuln===!0?other.dead||_this.pk(player,other):player.dead||_this.pk(other,player);return!1}});for(var k=0;k<this.orbs.length;k++)if(player.pos.x<this.orbs[k].x+this.orbs[k].w&&player.pos.x+player.size.hx>this.orbs[k].x&&player.pos.y<this.orbs[k].y+this.orbs[k].h&&player.pos.y+player.size.hy>this.orbs[k].y){var rid=this.orbs[k].id;player.updateMana(this.orbs[k].w),this.orbs.splice(k,1);for(var l=0;l<this.getplayers.allplayers.length;l++)this.getplayers.allplayers[l].instance&&this.getplayers.allplayers[l].mp!=player.mp&&this.getplayers.allplayers[l].instance.send("o.r."+rid+"|"+player.mp);break}_.forEach(this.chests,function(chest){chest&&chest.taken===!1&&player.pos.x<chest.x+chest.width&&player.pos.x+player.size.hx>chest.x&&player.pos.y<chest.y+chest.height&&player.pos.y+player.size.hy>chest.y&&chest.doTake(player)}),this.config.server&&_.forEach(this.config.flagObjects,function(fo){player.pos.x<fo.x+fo.width/2&&player.pos.x+player.size.hx/2>fo.x&&player.pos.y<fo.y+fo.height/2&&player.pos.y+player.size.hy/2>fo.y&&("flag"==fo.type&&fo.isHeld===!1&&fo.isActive&&0===player.hasFlag?fo.doTake(player):player.hasFlag>0&&fo.slotFlag(player))});var b=10,h=player.hitGrid();void 0!==h&&(h.ne.t>0&&h.nw.t>0?(player.pos.y+=b,player.hitFrom=1,player.collision=!0):h.sw.t>0&&h.se.t>0?(player.pos.y=parseInt(64*h.sw.y-player.size.hy),player.doLand()):h.nw.t>0&&h.sw.t>0?(player.pos.x+=15,player.hitFrom=0,player.collision=!0):h.ne.t>0&&h.se.t>0?(player.pos.x-=15,player.hitFrom=0,player.collision=!0):h.ne.t>0&&h.se.t>0?(player.pos.x-=15,player.hitFrom=0,player.collision=!0):2===player.standing||(h.ne.t>0||h.se.t>0?h.e.t>0?(player.pos.x-=15,player.hitFrom=0,player.collision=!0):h.n.t>0?(player.pos.y+=b,player.hitFrom=1,player.collision=!0):(player.pos.y=parseInt(64*h.sw.y-player.size.hy),player.doLand()):(h.nw.t>0||h.sw.t>0)&&(h.w.t>0?(player.pos.x+=15,player.hitFrom=0,player.collision=!0):h.n.t>0?(player.pos.y+=b,player.hitFrom=1,player.collision=!0):(player.pos.y=parseInt(64*h.sw.y-player.size.hy),player.doLand()))))}},game_core.prototype.client_on_chesttake=function(data){var split=data.split("|"),id=split[0];split[1];_.forEach(this.chests,function(chest){chest.id==id&&(chest.opening=!0)})},game_core.prototype.client_on_chestremove=function(data){var _this=this,split=data.split("|"),id=split[0];split[1];_.forEach(this.chests,function(chest){if(chest.id==id)return _.remove(_this.chests,{id:chest.id}),!1})},game_core.prototype.client_onflagadd=function(data){var playerSource,split=data.split("|"),mp=split[0],slotName=split[1],flagName=split[2];_.forEach(this.getplayers.allplayers,function(ply){if(ply.mp==mp)return playerSource=ply,!1}),playerSource.hasFlag=0;var targetSlot,flagSlotted;if(_.forEach(this.config.flagObjects,function(fo){fo.name==slotName?targetSlot=fo:fo.name==flagName&&(flagSlotted=fo)}),flagSlotted.x=targetSlot.x-targetSlot.width/2,flagSlotted.y=targetSlot.y-targetSlot.height/2,flagSlotted.sourceSlot=targetSlot.name,flagSlotted.visible=!0,flagSlotted.isActive=!1,flagSlotted.isPlanted=!0,flagSlotted.isHeld=!1,flagSlotted.onCooldown=!0,playerSource.mp!=this.players.self.mp){var msg={action:"slotFlag",playerName:playerSource.playerName,playerTeam:playerSource.team,flagName:flagSlotted.name,targetSlot:flagSlotted.targetSlot};(new game_toast).show(msg)}this.updateTerritory()},game_core.prototype.client_onflagremove=function(data){var playerSource,flagTaken,split=data.split("|"),mp=split[0],flagName=split[1];split[2];_.forEach(this.getplayers.allplayers,function(ply){if(ply.mp==mp)return playerSource=ply,!1});_.forEach(this.config.flagObjects,function(flag){if(flag.name==flagName)return flagTaken=flag,flagTaken.targetSlot=flag.getTargetSlot(parseInt(playerSource.team),flag.sourceSlot),!1}),flagTaken.visible=!1,flagTaken.isHeld=!0,flagTaken.isActive=!1,flagTaken.heldBy=playerSource.mp,"midFlag"==flagTaken.name?playerSource.hasFlag=1:"redFlag"==flagTaken.name?playerSource.hasFlag=2:"blueFlag"==flagTaken.name&&(playerSource.hasFlag=3);var msg={action:"takeFlag",playerName:playerSource.playerName,playerTeam:playerSource.team,flagName:flagTaken.name,targetSlot:flagTaken.targetSlot};(new game_toast).show(msg)},game_core.prototype.client_onflagchange=function(data){var split=data.split("|"),flagName=split[0],flagVisible="true"==split[1],toastMsg=JSON.parse(split[2]),flagObj=this.config._.find(this.config.flagObjects,{name:flagName});flagObj.visible=flagVisible,toastMsg&&(new game_toast).show(toastMsg)},game_core.prototype.client_on_orbremoval=function(data){for(var split=data.split("|"),id=split[0],orbFound=(split[1],!1),i=0;i<this.orbs.length;i++)if(this.orbs[i].id==id){orbFound=!0,this.orbs[i].x=-100,this.orbs[i].y=-100,this.orbs[i].r=!0,this.orbs.splice(i,1);break}orbFound===!0&&this.prerenderer()},game_core.prototype.process_input=function(player){var x_dir=0,y_dir=0,ic=player.inputs.length;if(ic)for(var j=0;j<ic;++j)if(!(player.inputs[j].seq<=player.last_input_seq))for(var input=player.inputs[j].inputs,c=input.length,i=0;i<c;++i){var key=input[i];"l"==key?(player.dir=1,1===player.landed?player.doWalk(player.dir):player.setAngle(1)):"r"==key?(player.dir=0,1===player.landed?player.doWalk(player.dir):player.setAngle(0)):"d"==key?this.inputDelay===!1:"sp"==key&&player.cooldown===!1&&player.doAbility(),"u"==key?(player.doFlap(),y_dir=player.vy,x_dir=player.vx,0===player.dir,1===player.dir):player.flap=!1}this.server||(this.players.self.cur_state.pos=this.pos(this.players.self.pos));var resulting_vector=this.physics_movement_vector_from_direction(x_dir,y_dir);return player.inputs.length&&(player.last_input_time=player.inputs[ic-1].time,player.last_input_seq=player.inputs[ic-1].seq),player.lpos=player.pos,resulting_vector},game_core.prototype.timeoutInputDelay=function(){this.inputDelay=!1},game_core.prototype.physics_movement_vector_from_direction=function(x,y){return{x:(x*(.015*this.playerspeed)).fixed(3),y:(y*(.015*this.playerspeed)).fixed(3)}},game_core.prototype.update_physics=function(){_.forEach(this.getplayers.allplayers,function(player){player.update(),player.a>0?player.a-=.5:player.a<0&&(player.a+=.5)}),this.server?this.server_update_physics():this.client_update_physics()},game_core.prototype.server_update_physics=function(){var new_dir,_this=this;_.forEach(this.getplayers.allplayers,function(ply){ply.old_state.pos=_this.pos(ply.pos),new_dir=_this.process_input(ply),ply.pos=_this.v_add(ply.old_state.pos,new_dir),_this.check_collision(ply),ply.inputs=[]})},game_core.prototype.server_update=function(){var _this=this;this.config.server_time=this.local_time;var laststate=new Object;_.forEach(this.getplayers.allplayers,function(player,index){var bufArr=new ArrayBuffer(768),bufView=new Int16Array(bufArr,16*index,16);0===player.pos.x&&0===player.pos.y||(bufView[0]=player.pos.x,bufView[1]=player.pos.y,bufView[2]=player.dir,bufView[3]=player.flap?1:0,bufView[4]=player.landed,bufView[5]=player.vuln?1:0,bufView[6]=player.a,bufView[7]=player.vx,bufView[8]=player.vy,bufView[9]=player.hasFlag,bufView[10]=player.bubble?1:0,bufView[11]=player.visible?1:0,bufView[12]=index,laststate[player.mp]=bufArr,laststate[player.mis]=player.last_input_seq,player.flap===!0&&(player.flap=!1),player.abil>0&&(player.abil=0))}),_.forEach(this.events,function(evt){if(evt.state!==evt.STATE_STOPPED&&evt.update()===!0)switch(evt.type){case evt.TYPE_CHEST:var id=_this.getUID();"ec"==evt.id&&_this.addChest({i:id,x:evt.spawn.x,y:evt.spawn.y,t:evt.passive.type,d:evt.passive.duration,m:evt.passive.modifier}),laststate[evt.id]={i:id,x:evt.spawn.x,y:evt.spawn.y,t:evt.passive.type,d:evt.passive.duration,m:evt.passive.modifier};break;case evt.TYPE_FLAG_CARRIED_COOLDOWN:laststate[evt.id]={t:evt.timer,f:evt.flag.name,p:evt.flag.heldBy};break;case evt.TYPE_FLAG_SLOTTED_COOLDOWN:laststate[evt.id]={t:evt.timer,f:evt.flag.name}}}),laststate.t=this.config.server_time,_.forEach(this.getplayers.allplayers,function(ply){ply.instance&&(ply.instance.emit("onserverupdate",laststate),ply.instance&&ply.instance.sendBuffer&&(ply.instance.sendBuffer.length=0))});for(var k in laststate)delete laststate[k];laststate=null},game_core.prototype.handle_server_input=function(client,input,input_time,input_seq){this.server||client.userid!=this.players.self.instance.userid?_.forEach(this.getplayers.allplayers,function(player){if(player.instance&&player.instance.userid==client.userid)return player.inputs.push({inputs:input,time:input_time,seq:input_seq}),!1}):player_client=this.players.self},game_core.prototype.client_handle_input=function(key){if(this.players.self.vuln!==!0&&this.players.self.active!==!1){var x_dir=0,y_dir=0,input=[];if(this.client_has_input=!1,(this.keyboard.pressed("A")||this.keyboard.pressed("left")||"A"==key)&&input.push("l"),(this.keyboard.pressed("D")||this.keyboard.pressed("right")||"D"==key)&&input.push("r"),(this.keyboard.pressed("S")||this.keyboard.pressed("down"))&&input.push("d"),(this.keyboard.pressed("W")||this.keyboard.pressed("up")||"u"==key)&&input.push("u"),this.keyboard.pressed("space")&&input.push("sp"),input.length){this.input_seq+=1,this.players.self.inputs.push({inputs:input,time:this.local_time.fixed(3),seq:this.input_seq});var server_packet="i.";return server_packet+=input.join("-")+".",server_packet+=this.local_time.toFixed(3).replace(".","-")+".",server_packet+=this.input_seq,this.socket.send(server_packet),server_packet=null,y_dir=this.players.self.vy,x_dir=this.players.self.vx,this.physics_movement_vector_from_direction(x_dir,y_dir)}return this.physics_movement_vector_from_direction(x_dir,y_dir)}},game_core.prototype.client_process_net_prediction_correction2=function(){if(this.server_updates.length){var latest_server_data=this.server_updates[this.server_updates.length-1],self_sp=new Int16Array(latest_server_data[this.players.self.mp],16*this.players.self.bufferIndex,16),my_server_pos={x:self_sp[0],y:self_sp[1]};_.isEqual(this.players.self.old_state.pos,this.players.self.cur_state.pos)!==!0&&(this.players.self.cur_state.pos=this.pos(my_server_pos),this.client_update_physics(),this.client_update_local_position()),self_sp=null}},game_core.prototype.client_process_net_prediction_correction=function(){if(this.server_updates.length){var latest_server_data=this.server_updates[this.server_updates.length-1],self_sp=new Int16Array(latest_server_data[this.players.self.mp],16*this.players.self.bufferIndex,16),my_server_pos={x:self_sp[0],y:self_sp[1]},my_last_input_on_server=latest_server_data[this.players.self.mis];if(my_last_input_on_server){for(var lastinputseq_index=-1,i=0;i<this.players.self.inputs.length;++i)if(this.players.self.inputs[i].seq==my_last_input_on_server){lastinputseq_index=i;break}if(lastinputseq_index!=-1){var number_to_clear=Math.abs(lastinputseq_index- -1);this.players.self.inputs.splice(0,number_to_clear),this.players.self.cur_state.pos=this.pos(my_server_pos),this.players.self.last_input_seq=lastinputseq_index,this.client_update_physics(),this.client_update_local_position()}else _.isEqual(this.players.self.old_state.pos,this.players.self.cur_state.pos)!==!0&&(this.players.self.cur_state.pos=this.v_lerp(this.players.self.pos,this.pos(my_server_pos),this._pdt*this.client_smooth),this.client_update_physics(),this.client_update_local_position())}self_sp=null}},game_core.prototype.client_process_net_updates=function(){if(this.server_updates.length){for(var _this=this,current_time=this.client_time,count=this.server_updates.length-1,target=null,previous=null,i=0;i<count;++i){var point=this.server_updates[i],next_point=this.server_updates[i+1];if(current_time>point.t&&current_time<next_point.t){target=next_point,previous=point;break}}if(target||(target=this.server_updates[0],previous=this.server_updates[0]),target&&previous){this.target_time=target.t;var difference=this.target_time-current_time,max_difference=(target.t-previous.t).fixed(3),time_point=(difference/max_difference).fixed(3);(Number.isNaN(time_point)||Math.abs(time_point)===Number.POSITIVE_INFINITY)&&(time_point=0),this.time_point=time_point;var ghostStub,vt,vp,self_pp,self_tp,lerp_t=(this.server_updates[this.server_updates.length-1],{x:NaN,y:NaN}),lerp_p={x:NaN,y:NaN};if(_.forEach(this.getplayers.allplayers,function(player,index){if(player!=_this.players.self){if(void 0==target[player.mp]||void 0==previous[player.mp])return!1;vt=new Int16Array(target[player.mp],16*index,16),vp=new Int16Array(previous[player.mp],16*index,16);var p={};p.pos={},p.pos.x=parseInt(vt[0]),p.pos.y=parseInt(vt[1]),lerp_t.x=parseInt(vt[0]),lerp_t.y=parseInt(vt[1]),lerp_p.x=parseInt(vp[0]),lerp_p.y=parseInt(vp[1]),ghostStub=_this.v_lerp(lerp_p,lerp_t,time_point),player.pos=_this.v_lerp(p.pos,ghostStub,_this._pdt*_this.client_smooth),player.dir=vt[2],player.flap=1===vt[3],player.landed=vt[4],player.vuln=1===vt[5],player.a=vt[6],player.vx=vt[7],player.vy=vt[8],player.hasFlag=vt[9],player.bubble=1===vt[10],player.visible=1===vt[11],player.bufferIndex=index}else{var self_vt=new Int16Array(target[player.mp],16*index,16),self_vp=new Int16Array(previous[player.mp],16*index,16);self_tp={x:parseInt(self_vt[0]),y:parseInt(self_vt[1])},self_pp={x:parseInt(self_vp[0]),y:parseInt(self_vp[1])},player.bufferIndex=index,_this.players.self.vuln=1===self_vt[5],_this.players.self.hasFlag=self_vt[9],_this.players.self.bubble=1===self_vt[10],_this.players.self.visible=1===self_vt[11],_this.players.self.bufferIndex=index}}),_.has(target,"ec")){if(!target.ec)return!1;_this.addChest(target.ec),target.ec=null}if(_.has(target,"fc")){var cflag=_.find(_this.clientCooldowns,{name:target.fc.f});cflag.heldBy=target.fc.p,cflag.timer=target.fc.t;var flag=_.find(this.config.flagObjects,{name:target.fc.f});cflag.target=flag.targetSlot,cflag.src=flag.sourceSlot;var ply=_.find(this.getplayers.allplayers,{mp:target.fc.p});ply&&("midFlag"==cflag.name?ply.hasFlag=1:"redFlag"==cflag.name?ply.hasFlag=2:"blueFlag"==cflag.name&&(ply.hasFlag=3))}if(_.has(target,"fs")){var flg=_.find(this.config.flagObjects,{name:target.fs.f});flg.timer=target.fs.t,0===target.fs.t&&flg.isActive===!1&&(flg.isActive=!0,flg.onCooldown=!1)}self_pp&&self_tp&&(this.players.self.pos=this.v_lerp(this.players.self.pos,this.v_lerp(self_pp,self_tp,this._pdt*this.client_smooth),this._pdt*this.client_smooth))}}},game_core.prototype.addChest=function(chest){if(this.server){var game_chest_server=require("./class.chest");this.chests.push(new game_chest_server(chest,!1,this.getplayers,this.config))}else this.chests.push(new game_chest(chest,!0,this.getplayers,this.config))},game_core.prototype.client_onserverupdate_recieved=function(data){this.config.server_time=data.t,this.client_time=this.config.server_time-this.net_offset/1e3,this.server_updates.push(data),this.server_updates.length>=60*this.buffer_size&&this.server_updates.splice(0,1),this.oldest_tick=this.server_updates[0].t,this.client_process_net_prediction_correction()},game_core.prototype.client_update_local_position=function(){(this.local_time-this.players.self.state_time)/this._pdt,this.players.self.old_state.pos,this.players.self.cur_state.pos;this.check_collision(this.players.self)},game_core.prototype.client_update_physics=function(){this.players.self.old_state.pos=this.pos(this.players.self.cur_state.pos);var nd=this.process_input(this.players.self);this.players.self.cur_state.pos=this.v_add(this.players.self.old_state.pos,nd),this.players.self.state_time=this.local_time},game_core.prototype.client_update=function(){if("hp"!=this.players.self.mp){var _this=this;if(1!==this.players.self.landed){var pad=0;this.cam.x=clamp(-this.players.self.pos.x+this.viewport.width/2,-(this.config.world.width-this.viewport.width)-pad,pad),this.cam.y=clamp(-this.players.self.pos.y+this.viewport.height/2,-(this.config.world.height-this.viewport.height)-pad,pad)}this.ctx.clearRect(-this.cam.x,-this.cam.y,this.viewport.width+128,this.viewport.height+128),this.flashBang>0&&(this.ctx.beginPath(),1===this.flashBang?this.ctx.fillStyle="white":this.ctx.fillStyle="red",this.ctx.rect(-this.cam.x,-this.cam.y,this.viewport.width+128,this.viewport.height+128),this.ctx.fill(),this.ctx.closePath(),this.flashBang=0),this.bg&&this.ctx.drawImage(this.bg,0,0),this.fg&&(this.ctx.drawImage(this.barriers,0,0),this.ctx.drawImage(this.fg,0,0)),this.client_handle_input(),this.client_process_net_updates(),_.forEach(this.getplayers.allplayers,function(ply){ply!=_this.players.self&&ply.pos.y+_this.cam.y+ply.size.hy>0&&ply.pos.y+_this.cam.y-ply.size.hy<=_this.viewport.height&&ply.pos.x+_this.cam.x-ply.size.hx<=_this.viewport.width&&ply.pos.x+_this.cam.x+ply.size.hx>0&&ply.draw()}),this.client_update_local_position(),this.players.self.draw(),_.forEach(this.spritesheets,function(ss){ss.update()}),_.forEach(this.chests,function(chest){chest.draw()}),_.forEach(this.config.flagObjects,function(flagObj){"flag"==flagObj.type&&flagObj.draw()}),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.translate(this.cam.x,this.cam.y),this.client_refresh_fps()}},game_core.prototype.create_timer=function(){setInterval(function(){this._dt=(new Date).getTime()-this._dte,this._dte=(new Date).getTime(),this.local_time+=this._dt/1e3}.bind(this),4)},game_core.prototype.create_physics_simulation=function(){setInterval(function(){this._pdt=((new Date).getTime()-this._pdte)/1e3,this._pdte=(new Date).getTime(),this.update_physics()}.bind(this),15)},game_core.prototype.client_create_ping_timer=function(){setInterval(function(){this.last_ping_time=(new Date).getTime()-this.fake_lag,this.socket.send("p."+this.last_ping_time)}.bind(this),250)},game_core.prototype.client_create_configuration=function(){this.show_help=!1,this.naive_approach=!1,this.show_server_pos=!1,this.show_dest_pos=!1,this.client_predict=!0,this.input_seq=0,this.client_smoothing=!0,this.client_smooth=25,this.net_latency=.001,this.net_ping=.001,this.last_ping_time=.001,this.fake_lag=0,this.fake_lag_time=0,this.net_offset=100,this.buffer_size=2,this.target_time=.01,this.oldest_tick=.01,this.client_time=.01,this.config.server_time=.01,this.dt=.016,this.fps=0,this.fps_avg_count=0,this.fps_avg=0,this.fps_avg_acc=0,this.lit=0,this.llt=(new Date).getTime()},game_core.prototype.client_create_debug_gui=function(){this.gui=new dat.GUI;var _playersettings=this.gui.addFolder("Your settings");this.colorcontrol=_playersettings.addColor(this,"color"),this.colorcontrol.onChange(function(value){this.players.self.color=value,localStorage.setItem("color",value),this.socket.send("c."+value)}.bind(this)),_playersettings.open();var _othersettings=this.gui.addFolder("Methods");_othersettings.add(this,"naive_approach").listen(),_othersettings.add(this,"client_smoothing").listen(),_othersettings.add(this,"client_smooth").listen(),_othersettings.add(this,"client_predict").listen();var _debugsettings=this.gui.addFolder("Debug view");_debugsettings.add(this,"show_help").listen(),_debugsettings.add(this,"fps_avg").listen(),_debugsettings.add(this,"show_server_pos").listen(),_debugsettings.add(this,"show_dest_pos").listen(),_debugsettings.add(this,"local_time").listen(),_debugsettings.open();var _consettings=this.gui.addFolder("Connection");_consettings.add(this,"net_latency").step(.001).listen(),_consettings.add(this,"net_ping").step(.001).listen();var lag_control=_consettings.add(this,"fake_lag").step(.001).listen();lag_control.onChange(function(value){this.socket.send("l."+value)}.bind(this)),_consettings.open();var _netsettings=this.gui.addFolder("Networking");_netsettings.add(this,"net_offset").min(.01).step(.001).listen(),_netsettings.add(this,"server_time").step(.001).listen(),_netsettings.add(this,"client_time").step(.001).listen(),_netsettings.open()},game_core.prototype.client_reset_positions=function(){for(var i=0;i<this.getplayers.allplayers.length;i++)this.getplayers.allplayers[i].old_state.pos=this.pos(this.getplayers.allplayers[i].pos),this.getplayers.allplayers[i].pos=this.pos(this.getplayers.allplayers[i].pos),this.getplayers.allplayers[i].cur_state.pos=this.pos(this.getplayers.allplayers[i].pos),this.getplayers.allplayers[i].draw();this.players.self.old_state.pos=this.pos(this.players.self.pos),this.players.self.pos=this.pos(this.players.self.pos),this.players.self.cur_state.pos=this.pos(this.players.self.pos),this.players.self.draw()},game_core.prototype.client_onreadygame=function(data){var server_time=parseFloat(data.replace("-","."));this.local_time=server_time+this.net_latency},game_core.prototype.resizeCanvas=function(){if(void 0!=this.viewport){var winWidth=(window.devicePixelRatio,window.innerWidth),winHeight=window.innerHeight;this.viewport.width=winWidth,this.viewport.height=winHeight,this.viewport.style.width=this.viewport.width,this.viewport.style.height=this.viewport.height}},game_core.prototype.client_onplayernames=function(data){for(var p,data=JSON.parse(data),i=0;i<data.length;i++)p=_.find(this.getplayers.allplayers,{mp:data[i].mp}),p&&(""!=data[i].name&&(p.playerName=data[i].name),data[i].team>0&&0===p.team&&(p.team=parseInt(data[i].team)));this.players.self.active=!0,this.players.self.visible=!0,this.players.self.vuln=!1,assets.playerName&&(this.players.self.playerName=assets.playerName)},game_core.prototype.client_onjoingame=function(data){var _this=this,alldata=data.split("|");this.mp=alldata[0],this.gameid=alldata[1];for(var chests=JSON.parse(alldata[2]),team=parseInt(alldata[3]),playerName=alldata[4],flags=JSON.parse(alldata[5]),i=0;i<this.getplayers.allplayers.length;i++)this.getplayers.allplayers[i].mp==alldata[0]?(this.getplayers.allplayers[i].team=team,playerName&&playerName.length>2&&(this.getplayers.allplayers[i].playerName=playerName),this.getplayers.allplayers[i].active=!0,"hp"==this.players.self.mp):"hp"==this.getplayers.allplayers[i].mp&&this.getplayers.allplayers.splice(i,1);_.forEach(chests,function(chest){_this.chests.push(new game_chest(chest,!0,_this.getplayers,_this.config))});var cflag;this.config.preflags=[],_.forEach(flags,function(flag){cflag=_.find(_this.config.flagObjects,{name:flag.name}),cflag?cflag.visible=flag.visible:_this.config.preflags.push(flag)})},game_core.prototype.client_onhostgame=function(data){var _this=this,alldata=data.split("|");this.mp=alldata[0],this.gameid=alldata[1];var chests=JSON.parse(alldata[2]),team=parseInt(alldata[3]),playerName=alldata[4],flags=JSON.parse(alldata[5]);this.players.self.host=!1,this.players.self.state="connected.joined.waiting",this.players.self.info_color="#00bb00";for(var i=0;i<this.getplayers.allplayers.length;i++)this.getplayers.allplayers[i].mp==alldata[0]?(this.getplayers.allplayers[i].team=team,this.getplayers.allplayers[i].playerName=playerName,this.getplayers.allplayers[i].active=!0,"hp"==this.players.self.mp&&(this.getplayers.allplayers[i].isLocal=!0,this.players.self=this.getplayers.allplayers[i],this.players.self.active=!1,this.players.self.visible=!0,this.players.self.dead=!1,this.players.self.vuln=!1,this.players.self.landed=0,this.socket.emit("message","n."+this.players.self.mp+"."+this.gameid))):"hp"==this.getplayers.allplayers[i].mp&&this.getplayers.allplayers.splice(i,1);_.forEach(chests,function(chest){_this.chests.push(new game_chest(chest,!0,_this.getplayers,_this.config))});var cflag;this.config.preflags=[],_.forEach(flags,function(flag){cflag=_.find(_this.config.flagObjects,{name:flag.name}),cflag?cflag.visible=flag.visible:_this.config.preflags.push(flag)})},game_core.prototype.client_onhostgame_orig=function(data){var server_time=parseFloat(data.replace("-","."));this.local_time=server_time+this.net_latency,this.players.self.host=!0,this.players.self.state="hosting.waiting for a player",this.players.self.info_color="#cc0000",this.players.self.mp="hp",this.players.self.mis="his";for(var i=0;i<this.getplayers.allplayers.length;i++)"hp"==this.getplayers.allplayers[i].mp&&(this.players.self=this.getplayers.allplayers[i]);this.client_reset_positions()},game_core.prototype.client_onconnected=function(data){this.players.self.id=data.id,this.players.self.state="connected",this.players.self.online=!0},game_core.prototype.client_on_otherclientcolorchange=function(data){},game_core.prototype.client_onping=function(data){this.net_ping=(new Date).getTime()-parseFloat(data),this.net_latency=this.net_ping/2},game_core.prototype.client_onnetmessage=function(data){var commands=data.split("."),command=commands[0],subcommand=commands[1]||null,commanddata=commands[2]||null;switch(command){case"s":switch(subcommand){case"h":this.client_onhostgame(commanddata);break;case"j":this.client_onjoingame(commanddata);break;case"r":this.client_onreadygame(commanddata);break;case"e":this.client_ondisconnect(commanddata);break;case"p":this.client_onping(commanddata);break;case"n":this.client_onplayernames(commanddata)}break;case"o":switch(subcommand){case"r":this.client_on_orbremoval(commanddata);break;case"g":this.client_on_getorbs(commanddata)}break;case"c":switch(subcommand){case"t":this.client_on_chesttake(commanddata);break;case"r":this.client_on_chestremove(commanddata)}break;case"f":switch(subcommand){case"a":this.client_onflagadd(commanddata);break;case"r":this.client_onflagremove(commanddata);break;case"c":this.client_onflagchange(commanddata)}break;case"p":switch(subcommand){case"k":this.client_onplayerkilled(commanddata)}}},game_core.prototype.client_onplayerkilled=function(data){var split=data.split("|"),victim=_.find(this.getplayers.allplayers,{mp:split[0]}),victor=_.find(this.getplayers.allplayers,{mp:split[1]});victim.doKill(victor)},game_core.prototype.client_ondisconnect=function(data){for(var i=0;i<this.getplayers.allplayers.length;i++)this.getplayers.allplayers[i].mp==data&&(this.getplayers.allplayers[i].disconnected=!0,this.getplayers.allplayers[i].doKill())},game_core.prototype.client_connect_to_server=function(){this.socket=io.connect(),this.socket.on("connect",function(){this.players.self.state="connecting"}.bind(this)),this.socket.on("disconnect",this.client_ondisconnect.bind(this)),this.socket.on("onserverupdate",this.client_onserverupdate_recieved.bind(this)),this.socket.on("onconnected",this.client_onconnected.bind(this)),this.socket.on("error",this.client_ondisconnect.bind(this)),this.socket.on("message",this.client_onnetmessage.bind(this)),this.socket.on("addflag",this.client_onflagadd.bind(this)),this.socket.on("removeflag",this.client_onflagremove.bind(this))},game_core.prototype.client_refresh_fps=function(){this.fps=1/this.dt,this.fps_avg_acc+=this.fps,this.fps_avg_count++,this.fps_avg_count>=10&&(this.fps_avg=this.fps_avg_acc/10,this.fps_avg_count=1,this.fps_avg_acc=this.fps)},game_core.prototype.client_draw_info=function(){this.ctx.fillStyle="rgba(255,255,255,0.3)",this.show_help&&(this.ctx.fillText('net_offset : local offset of others players and their server updates. Players are net_offset "in the past" so we can smoothly draw them interpolated.',10,30),this.ctx.fillText("server_time : last known game time on server",10,70),this.ctx.fillText("client_time : delayed game time on client for other players only (includes the net_offset)",10,90),this.ctx.fillText("net_latency : Time from you to the server. ",10,130),this.ctx.fillText("net_ping : Time from you to the server and back. ",10,150),this.ctx.fillText("fake_lag : Add fake ping/lag for testing, applies only to your inputs (watch server_pos block!). ",10,170),this.ctx.fillText("client_smoothing/client_smooth : When updating players information from the server, it can smooth them out.",10,210),this.ctx.fillText(" This only applies to other clients when prediction is enabled, and applies to local player with no prediction.",170,230)),this.players.self.host&&(this.ctx.fillStyle="rgba(255,255,255,0.7)",this.ctx.fillText("You are the host",10,465)),this.ctx.fillStyle="rgba(255,255,255,1)"};var config=function(){this.preflags=null,this.ctx=null,this.flagObjects=[],this.world={},this.server=!0,this.keyboard=null,this.tilemapData=null,this._=null,this.clientCooldowns=[],this.chests=[],this.chestSpawnPoints=[],this.passives=[],this.events=[],this._=null,this.server_time=0};config.prototype.preflags=null,config.prototype.ctx=null,config.prototype.flagObjects=[],config.prototype.world={},config.prototype.server=!0,config.prototype.keyboard=null,config.prototype.tilemapData=null,config.prototype._=null,config.prototype.clientCooldowns=[],config.prototype.chests=[],config.prototype.chestSpawnPoints=[],config.prototype.passives=[],config.prototype.events=[],config.prototype._=null,config.prototype.server_time=0,config.prototype.gridToPixel=function(x,y){},module.exports=config;var assets=function(){};module.exports=new assets,getplayers.prototype.allplayers=[],module.exports=getplayers,egyptian_set.prototype.getSet=function(){var name_set=[];return name_set.egyptian=["Aakheperkare","Addaya","Ahhotpe","Ahmes","Ahmose","Ahmose-saneit","Ahmose-sipari","Akencheres","Akunosh","Amenakht","Amenakhte","Amenemhat","Amenemheb","Amenemopet","Amenhirkopshef","Amenhirwenemef","Amenhotpe","Amenmesse","Amenmose","Amennestawy","Amenope","Amenophis","Amenwahsu","Ameny","Amosis-ankh","Amoy","Amunemhat","Amunherpanesha","Amunhotpe","Anen","Ankh-Psamtek","Ankhef","Ankhefenamun","Ankhefenkhons","Ankhefenmut","Ankhsheshonq","Ankhtify","Ankhtyfy","Ankhu","Ankhuemhesut","Any","Apophis","Baba","Baenre","Bak","Bakenkhons","Bakenkhonsu","Bakenmut","Bakennefi","Bakenptah","Baky","Bata","Bay","Bek","Bengay","Besenmut","Butehamun","Denger","Deniuenkhons","Djadjaemankh","Djau","Djedefhor","Djedhor","Djedhoriufankh","Djedi","Djedkhonsiufankh","Djedkhonsuefankh","Djedptahefankh","Djedptahiufankh","Djehutmose","Djehuty","Djehutymose","Djenutymes","Djeserka","Djeserkare","Djeserkheprure","Djesersukhons","Djethutmose","Djhutmose","Genubath","Gua","Haankhef","Hapimen","Hapu","Hapuseneb","Hapymen","Haremakhet","Haremsat","Harkhebi","Harkhuf","Harmhabi","Harnakhte","Harsiese","Hay","Hemaka","Henenu","Henuka","Heqaemeheh","Heqaib","Herenamenpenaef","Herihor","Hesire","Hor","Horapollo","Hordedef","Horemheb","Hori","Hornedjitef","Horpais","Horwebbefer","Hrihor","Hunefer","Huy","Huya","Iawy","Ibana","Ibe","Idy","Ikeni","Ikui","Imhotep","Inarus","Inebni","Ineni","Inyotef","Ipi","Ipuwer","Ipuy","Ipy","Ishpi","Iu-Amun","Iufankh","Iufenamun","Iunmin","Iuseneb","Iuwlot","Iyerniutef","Iyimennuef","Iymeru","Jarha","Kadjadja","Kahma","Kaka","Kanakht","Karnefhere","Katenen","Kawab","Kay","Kemuny","Kenamun","Kenefer","Kerasher","Kha","Khaemhet","Khaemnetjeru","Khaemwaset","Khahor","Khakheperraseneb","Khay","Khensthoth","Kheruef","Khety","Khnemibre","Khnumhotep","Khnumhotpe","Khons","Khonsirdais","Khonskhu","Khonsuemwaset","Khufukhaf","Khui","Kuenre","Kysen","Maakha","Mahu","Mahuhy","Maiherpri","Manakhtuf","Manetho","Masaharta","May","Maya","Mehy","Meketre","Mekhu","Men","Menkheperraseneb","Menkheperre","Menmet-Ra","Menna","Mentuemhat","Mentuherkhepshef","Meremptor","Merenamun","Merenkhons","Merenptah","Mereruka","Merka","Mernebptah","Mery","Meryamun","Meryatum","Meryawy","Merymose","Meryptah","Meryrahashtef","Meryre","Mes","Min","Minkhat","Minmose","Minnakht","Mokhtar","Montjuemhat","Montjuhirkopshef","Montuemhet","Mose","Naga-ed-der","Nakhthorheb","Nakhtimenwast","Nakhtmin","Nakhtnebef","Naneferkeptah","Nebamun","Nebankh","Nebemakst","Nebhotep","Nebimes","Nebitka","Nebmaetre","Nebnefer","Nebnetjeru","Nebseni","Nebseny","Nebwennenef","Nechoutes","Neferhotep","Neferhotpe","Neferkheperuhersekheper","Nefermaet","Nefermenu","Neferrenpet","Neferti","Nehasy","Nehi","Nekau","Nekhwemmut","Nendjbaendjed","Nenedjebaendjed","Neneferkaptah","Nenkhefta","Nes","Nesamun","Neshi","Neshorpakhered","Neskhons","Nesmont","Nespaherenhat","Nespakashuty","Nespatytawy","Nespherenhat","Nessuimenopet","Nestanebetasheru","Nestefnut","Netihur","Nigmed","Nimlot","Niumateped","Pa-Siamun","Pabasa","Pabernefy","Padiamenet","Padiamenipet","Padiamun","Padineith","Paheripedjet","Pairy","Pait","Pakharu","Pakhneter","Pamont","Pamose","Pamu","Panas","Paneb","Paneferher","Panehesy","Paperpa","Paramesse","Parennefer","Pasebakhaenniut","Pasekhonsu","Paser","Pashedbast","Pashedu","Pasherdjehuty","Pawiaeadja","Paynedjem","Payneferher","Pediamun","Pediese","Pedihor","Penamun","Penbuy","Penmaat","Pennestawy","Pentaweret","Pentu","Pepynakhte","Peraha","Pinhasy","Pinotmou","Prahotpe","Pramessu","Preherwenemef","Prehirwennef","Prepayit","Psamtek","Psenamy","Psenmin","Ptahhemakhet","Ptahhemhat-Ty","Ptahhotep","Ptahhudjankhef","Ptahmose","Ptahshepses","Qenymin","Rahotep","Rahotpe","Raia","Ramessenakhte","Ramessu","Rekhmire","Reuser","Rewer","Roma-Roy","Rudamun","Sabef","Sabni","Salatis","Samut","Sanehet","Sasobek","Sawesit","Scepter","Sekhemkare","Sekhmire","Seneb","Senebtyfy","Senemut","Senmen","Sennedjem","Sennefer","Sennufer","Senui","Senwosret","Serapion","Sese","Setau","Setep","Sethe","Sethherwenemef","Sethhirkopshef","Sethnakhte","Sethnakte","Sethy","Setne","Setymerenptah","Shedsunefertum","Shemay","Shepenwepet","Si-Mut","Siamun","Siese","Sinuhe","Sipair","Sneferu","Somtutefnakhte","Surero","Suty","Sutymose","Takairnayu","Takany","Tasetmerydjehuty","Tayenimu","Tefibi","Tenermentu","Teti-en","Tetisheri","Tjaenhebyu","Tjahapimu","Tjaroy","Tjauemdi","Tjenna","Tjety","To","Tui","Tutu","Tymisba","Udjahorresne","Udjahorresneith","Uni","Userhet","Usermontju","Wadjmose","Wahibre-Teni","Wahka","Webaoner","Webensenu","Wedjakhons","Wenamun","Wendjabaendjed","Wendjebaendjed","Weni","Wennefer","Wennufer","Wepmose","Wepwawetmose","Werdiamenniut","Werirenptah","Yanhamu","Yey","Yii","Yuya","Zazamoukh"],
name_set.egyptian},"undefined"!=typeof global&&(module.exports=egyptian_set);var assets=require("./singleton.assets");Number.prototype.fixed=function(n){return n=n||3,parseFloat(this.toFixed(n))},game_player.prototype.pos={x:0,y:0},game_player.prototype.pos.x=0,game_player.prototype.pos.y=0,game_player.prototype.dead=!1,game_player.prototype.botAction=function(){this.config.keyboard&&this.config.keyboard._onKeyChange({keyCode:39},!1)},game_player.prototype.doFlap=function(){this.flap=!0,this.landed=0,this.vy=5*-(this.thrust+this.thrustModifier),0!==this.a&&(this.vx=this.thrust+this.thrustModifier)},game_player.prototype.doLand=function(){if(this.vy>10)return this.vy=0,void this.doKill();if(this.vy>6){var len=1500+1e3*(this.vy-6);return this.vy=this.vy/2,this.vy*=-1,void this.isVuln(len)}this.vx>0?(this.landed=2,this.vy=-.25,this.vx-=.025.toFixed(2),this.vx<0&&(this.vx=0,this.landed=1,this.a=0)):this.vx<0&&(this.landed=2,this.vy=-.25,this.vx+=.025.toFixed(2),this.vx>0&&(this.vx=0,this.landed=1,this.a=0)),0===this.vx&&(this.vx=0,this.landed=1,this.a=0)},game_player.prototype.doWalk=function(dir){this.landed=2,this.vx=this.thrust},game_player.prototype.takeFlag=function(flag,flagType){this.bubble&&(this.bubble=!1)},game_player.prototype.collision=!1,game_player.prototype.hitFrom=0,game_player.prototype.target=null,game_player.prototype.update=function(){if(this.tmd||(this.tmd=this.config.tilemapData),1===this.landed){if(this.collision===!1)return this.a=0,this.vx=0,void(this.vy=0);this.landed=2}if(this.vy+=this.config.world.gravity,this.vx=this.a/40*Math.cos(this.thrust+this.thrustModifier),this.pos.y+=this.vy.fixed(2),this.pos.x+=this.vx.fixed(2),this.collision===!0){switch(this.hitFrom){case 0:this.vx*=-1,this.a*=-1;break;case 1:this.vy*=-1,this.isVuln(750);break;case 2:this.vy=0,this.a=0;break;case 3:this.vx*=-1,this.vy*=-1,this.a*=-1,1===this.target.landed&&(this.target.landed=2),this.pos.x>this.target.pos.x?this.pos.x+=this.size.hx/2:this.pos.x-=this.size.hx/2}this.collision=!1,this.hitfrom=-1,this.target=null}else this.vx*=1;this.pos.x=this.pos.x.fixed(2),this.pos.y=this.pos.y.fixed(2),this.vx=this.vx.fixed(2)},game_player.prototype.setAngle=function(a){0===a?this.a>90?this.a=90:this.a+=2:this.a<-90?this.a=-90:this.a-=2},game_player.prototype.doStand=function(id){this.supportingPlatformId=id},game_player.prototype.doKill=function(victor){if(this.active=!1,this.dying!==!0){this.dying=!0,this.dead=!0;this.pos;this.vx=0,this.vy=0,this.a=0,this.bubble=!1,this.mp==this.config.players.self.mp&&(this.config.players.self.vx=0,this.config.players.self.vy=0,this.config.players.self.a=0,this.config.players.self.dead=!0,this.config.players.self.vuln=!0),this.hasFlag&&(this.dropFlag(),this.mp==this.config.players.self.mp&&this.config.players.self.dropFlag()),setTimeout(this.timeoutRespawn.bind(this,victor),2e3)}},game_player.prototype.timeoutRespawn=function(victor){if(this.disconnected){if(this.dead=!1,this.dying=!1,this.landed=1,this.bubble=!1,this.pos=this.config.gridToPixel(0,0),this.mp==this.config.players.self.mp){var ui=document.getElementById("splash");ui.style.display="block"}}else if(this.dead=!1,this.dying=!1,this.active=!0,this.landed=1,this.bubble=!1,this.progression=0,this.pos=this.config.gridToPixel(3,4),this.mp==this.config.players.self.mp&&(this.config.players.self=this,!this.config.server)){this.config.players.self.visible=!1,this.config.players.self.active=!1,this.config.players.self.pos=this.config.gridToPixel(3,4),this.config.players.self.dead=!1,this.config.players.self.landed=1,this.config.players.self.progression=0;var ui=document.getElementById("splash");ui.style.display="block"}},game_player.prototype.setPassive=function(data){switch(data.t){case 1:this.updateProgression(10);break;case 2:this.bubble=!0}},game_player.prototype.doCycleAbility=function(){this.ability!==-1&&(this.ability===this.abilities.length-1?this.ability=0:this.ability++)},game_player.prototype.doAbility=function(){if(this.vuln!==!0&&this.ability!==-1&&this.cooldown!==!0&&!(0!==this.abilities[this.ability].t&&new Date(this.abilities[this.ability].t).getTime()>(new Date).getTime())){var _this=this;switch(this.engaged===!1&&this.isLocal&&this.isEngaged(5e3),this.abil=this.abilities[this.ability].id,this.abilities[this.ability].label){case"burst":this.vx+=500;break;case"blink":0===this.dir?this.pos.x+=150:this.pos.x-=150;break;case"grapple":break;case"anchor":break;case"frost":break;case"cinder":break;case"confusion":}this.abilities[this.ability].cd>=1e3&&(this.cooldown=!0,setTimeout(_this.timeoutGlobalCooldown,3e3));var d=new Date;this.abilities[this.ability].cd>=1e3?this.abilities[this.ability].t=d.setSeconds(d.getSeconds()+this.abilities[this.ability].cd/1e3):this.abilities[this.ability].t=d.setSeconds(0,d.getSeconds()+this.abilities[this.ability].cd)}},game_player.prototype.timeoutGlobalCooldown=function(){this.cooldown=!1},game_player.prototype.updateProgression=function(val){val>0?(this.progression+=val,this.pointsTotal+=val,this.thrustModifier=25e-5*this.progression):this.progression-=val},game_player.prototype.updateMana=function(val){return val>0?(this.mana+=val,this.pointsTotal+=val,void(this.pointsTotal<this.levels[1]?(this.level=1,this.progression=this.mana):1===this.level&&this.pointsTotal>this.levels[1]?(this.level=2,this.abilities.push({label:"burst",id:1,cd:5e3,t:0}),this.ability=0,this.abilities.push({label:"frost",id:2,cd:250,gc:!1,t:0}),this.abilities.push({label:"blink",id:3,cd:5e3,gc:!0,t:0}),this.abilities.push({label:"grapple",id:4,cd:5e3,gc:!0,t:0}),this.abilities.push({label:"anchor",id:5,cd:5e3,gc:!0,t:0}),this.abilities.push({label:"cinder",id:6,cd:250,gc:!1,t:0}),this.abilities.push({label:"confusion",id:7,cd:6e4,gc:!0,t:0}),this.progression=this.mana):2===this.level&&this.pointsTotal>this.levels[2]?this.level=3:3===this.level&&this.pointsTotal>this.levels[3]?this.level=4:4===this.level&&this.pointsTotal>this.levels[4]?this.level=5:5===this.level&&this.pointsTotal>this.levels[5]?this.level=6:6===this.level&&this.pointsTotal>this.levels[6]?this.level=7:7===this.level&&this.pointsTotal>this.levels[7]?this.level=8:8===this.level&&this.pointsTotal>this.levels[8]?this.level=9:9===this.level&&this.pointsTotal>this.levels[9]?this.level=10:10===this.level&&this.pointsTotal>this.levels[10]&&(this.level=11))):(this.mana-=val,void(this.progression=this.mana))},game_player.prototype.isEngaged=function(len){var _this=this;this.engaged=!0,setTimeout(_this.timeoutEngaged.bind(this),len)},game_player.prototype.timeoutEngaged=function(){this.engaged=!1},game_player.prototype.isVuln=function(len){if(this.vuln!==!0){this.vuln=!0,this.isLocal&&this.isEngaged(len);setTimeout(this.timeoutVuln.bind(this),len);this.config.server&&this.hasFlag&&this.dropFlag()}},game_player.prototype.dropFlag=function(){if(this.hasFlag){var flagName;switch(this.hasFlag){case 1:flagName="midFlag";break;case 2:flagName="redFlag";break;case 3:flagName="blueFlag"}this.hasFlag=0;var flag=this.config._.find(this.config.flagObjects,{name:flagName});flag.reset(!1,this.game)}},game_player.prototype.timeoutVuln=function(){this.vuln=!1},game_player.prototype.getGrid=function(){return{x:Math.floor(this.pos.x/64),y:Math.floor(this.pos.y/64)}},game_player.prototype.getCoord=function(){return this.nw={x:Math.floor(this.pos.x/64),y:Math.floor(this.pos.y/64)},this.ne={x:Math.floor((this.pos.x+this.size.hx)/64),y:Math.floor(this.pos.y/64)},this.sw={x:Math.floor(this.pos.x/64),y:Math.floor((this.pos.y+this.size.hy)/64)},this.se={x:Math.floor((this.pos.x+this.size.hx)/64),y:Math.floor((this.pos.y+this.size.hy)/64)},this.n={x:Math.floor((this.pos.x+this.size.hx/2)/64),y:Math.floor(this.pos.y/64)},this.s={x:Math.floor((this.pos.x+this.size.hx/2)/64),y:Math.floor((this.pos.y+this.size.hy)/64)},this.e={x:Math.floor((this.pos.x+this.size.hx)/64),y:Math.floor((this.pos.y+this.size.hy/2)/64)},this.w={x:Math.floor(this.pos.x/64),y:Math.floor((this.pos.y+this.size.hy/2)/64)},{nw:this.nw,ne:this.ne,sw:this.sw,se:this.se,n:this.n,s:this.s,e:this.e,w:this.w}},game_player.prototype.hitGrid=function(){if(null!==this.tmd)return this.c=this.getCoord(),{nw:this.tmd[this.c.nw.y]&&this.tmd[this.c.nw.y][this.c.nw.x]?{t:parseInt(this.tmd[this.c.nw.y][this.c.nw.x]),x:this.c.nw.x,y:this.c.nw.y}:0,ne:this.tmd[this.c.ne.y]&&this.tmd[this.c.ne.y][this.c.ne.x]?{t:parseInt(this.tmd[this.c.ne.y][this.c.ne.x]),x:this.c.ne.x,y:this.c.ne.y}:0,sw:this.tmd[this.c.sw.y]&&this.tmd[this.c.sw.y][this.c.sw.x]?{t:parseInt(this.tmd[this.c.sw.y][this.c.sw.x]),x:this.c.sw.x,y:this.c.sw.y}:0,se:this.tmd[this.c.se.y]&&this.tmd[this.c.se.y][this.c.se.x]?{t:parseInt(this.tmd[this.c.se.y][this.c.se.x]),x:this.c.se.x,y:this.c.se.y}:0,e:this.tmd[this.c.e.y]&&this.tmd[this.c.e.y][this.c.e.x]?{t:parseInt(this.tmd[this.c.e.y][this.c.e.x]),x:this.c.e.x,y:this.c.e.y}:0,w:this.tmd[this.c.w.y]&&this.tmd[this.c.w.y][this.c.w.x]?{t:parseInt(this.tmd[this.c.w.y][this.c.w.x]),x:this.c.w.x,y:this.c.w.y}:0,n:this.tmd[this.c.n.y]&&this.tmd[this.c.n.y][this.c.n.x]?{t:parseInt(this.tmd[this.c.n.y][this.c.n.x]),x:this.c.n.x,y:this.c.n.y}:0,s:this.tmd[this.c.s.y]&&this.tmd[this.c.s.y][this.c.s.x]?{t:parseInt(this.tmd[this.c.s.y][this.c.s.x]),x:this.c.s.x,y:this.c.s.y}:0}},game_player.prototype.drawAbilities=function(){if(this.engaged===!1){this.config.ctx.beginPath(),this.config.ctx.strokeStyle="gray",this.config.ctx.moveTo(this.pos.x,this.pos.y-10),this.config.ctx.lineTo(this.pos.x+64,this.pos.y-10),this.config.ctx.lineWidth=3,this.config.ctx.stroke(),this.config.ctx.closePath();var progressPercent=this.progression/500,progressVal=progressPercent/100*64*100;this.config.ctx.beginPath(),this.config.ctx.strokeStyle="yellow",this.config.ctx.moveTo(this.pos.x,this.pos.y-10),this.config.ctx.lineTo(this.pos.x+progressVal,this.pos.y-10),this.config.ctx.lineWidth=3,this.config.ctx.stroke(),this.config.ctx.closePath()}},game_player.prototype.draw=function(){if(this.visible!==!1){var txtOffset=20;this.vuln&&(txtOffset=10),this.isLocal===!0&&this.drawAbilities(),this.config.ctx.save(),1==this.team?this.config.ctx.fillStyle="#FF6961":2==this.team?this.config.ctx.fillStyle="#6ebee6":this.config.ctx.fillStyle="white",this.config.ctx.font="16px Mirza",this.config.ctx.textAlign="center";var txt=this.playerName;this.config.ctx.fillText(txt,this.pos.x+this.size.hx/2,this.pos.y-txtOffset),this.config.ctx.restore(),this.player_abilities_enabled&&this.isLocal&&this.ability!==-1&&this.config.ctx.drawImage(document.getElementById("ability-"+this.abilities[this.ability].label),this.pos.x+this.size.hx/2-game.ctx.measureText(txt).width/2-20,this.pos.y-txtOffset-12,15,15);var img,imgW,imgH;if(this.dead===!0?(img=assets.animate_gg,imgW=64,imgH=64):this.vuln===!0?(img=1===this.dir?assets.p1stun_l:assets.p1stun_r,imgW=64,imgH=64):this.flap===!0?(this.flap=!1,img=1===this.dir?assets.p1l:assets.p1r,imgW=64,imgH=64):1===this.landed?(img=1===this.dir?assets.p1stand_l:assets.p1stand_r,imgW=64,imgH=64):2===this.landed?(img=1===this.dir?assets.p1skid_l:assets.p1skid_r,imgW=64,imgH=64):(img=1===this.dir?assets.p2l:assets.p2r,imgW=64,imgH=64),this.hasFlag>0){var flag=this.config._.find(this.config.clientCooldowns,{heldBy:this.mp});if(flag&&0===flag.timer){for(var f=0;f<this.config.flagObjects.length;f++)"midFlag"==this.config.flagObjects[f].name&&1===this.hasFlag?this.config.flagObjects[f].reset(!1,this.game):"redFlag"==this.config.flagObjects[f].name&&2===this.hasFlag?this.config.flagObjects[f].reset(!1,this.game):"blueFlag"==this.config.flagObjects[f].name&&3===this.hasFlag&&this.config.flagObjects[f].reset(!1,this.game);this.hasFlag=0}var flagImg;switch(this.hasFlag){case 1:flagImg=0===this.dir?assets.flag_mid_r:assets.flag_mid_l;break;case 2:flagImg=0===this.dir?assets.flag_red_r:assets.flag_red_l;break;case 3:flagImg=0===this.dir?assets.flag_blue_r:assets.flag_blue_l}flagImg&&flag?(this.config.ctx.drawImage(flagImg,0===this.dir?this.pos.x-this.size.hx/2:this.pos.x+this.size.hx/2,this.pos.y-this.size.hx/2,64,64),this.config.ctx.font="18px Mirza",this.config.ctx.fillStyle=1===this.hasFlag?"#000":"#fff",this.config.ctx.textAlign="center",flag&&this.config.ctx.fillText(flag.timer,0===this.dir?this.pos.x-5:this.pos.x+this.size.hx+5,this.pos.y-5)):this.hasFlag=0}String(window.location).indexOf("debug")==-1&&this.visible===!0&&this.config.ctx.drawImage(img,this.pos.x,this.pos.y,imgW,imgH),this.bubble===!0&&this.config.ctx.drawImage(assets.ability_bubble,this.pos.x-8,this.pos.y-8,76,76)}},"undefined"!=typeof global&&(module.exports=game_player);var game_toast=require("./class.toast"),_=require("lodash"),assets=require("./singleton.assets");game_flag.prototype.targetSlot=null,game_flag.prototype.getTargetSlot=function(team,sourceSlot){team=parseInt(team);var targetSlot=null;switch(sourceSlot){case"midSlot":targetSlot=1===team?"slot6":"slot5";break;case"slotRed":targetSlot="slot1";break;case"slotBlue":targetSlot="slot10";break;case"slot1":targetSlot=1===team?"slotRed":"slot2";break;case"slot2":targetSlot="redFlag"==this.name?1===team?"slot1":"slot3":1===team?"slot3":"slot1";break;case"slot3":targetSlot="redFlag"==this.name?1===team?"slot2":"slot4":1===team?"slot4":"slot2";break;case"slot4":targetSlot="redFlag"==this.name?1===team?"slot3":"slot5":1===team?"slot5":"slot3";break;case"slot5":targetSlot="redFlag"==this.name?1===team?"slot4":"slot6":1===team?"midSlot":"slot4";break;case"slot6":targetSlot="blueFlag"==this.name?2===team?"slot7":"slot5":2===team?"midSlot":"slot7";break;case"slot7":targetSlot="blueFlag"==this.name?2===team?"slot8":"slot6":2===team?"slot6":"slot8";break;case"slot8":targetSlot="blueFlag"==this.name?2===team?"slot9":"slot7":2===team?"slot7":"slot9";break;case"slot9":targetSlot="blueFlag"==this.name?2===team?"slot10":"slot8":2===team?"slot8":"slot10";break;case"slot10":targetSlot="blueFlag"==this.name?2===team?"slotBlue":"slot9":2===team?"slot9":"slotBlue"}return targetSlot},game_flag.prototype.setter=function(obj){this.id="flg"+obj.id,this.name=obj.name,this.x=parseInt(obj.x),this.y=parseInt(obj.y),this.width=parseInt(obj.width),this.height=parseInt(obj.height),"slot"==this.type&&this.ctx?this.image=assets.flag_slot:this.ctx&&"flag"==this.type&&("midFlag"==this.name?this.image=assets.flag_mid_r:"redFlag"==this.name?this.image=assets.flag_red_l:"blueFlag"==this.name&&(this.image=assets.flag_blue_r))},game_flag.prototype.doTake=function(player){if(this.isActive!==!1&&this.onCooldown!==!0){var _this=this;if(this.isHeld===!1){if(this.isHeld=!0,0!==player.hasFlag)return void(this.isHeld=!1);if(1===player.team&&"redFlag"==this.name)return void(this.isHeld=!1);if(2===player.team&&"blueFlag"==this.name)return void(this.isHeld=!1);var flagType=1;if("redFlag"==this.name)flagType=2;else if("blueFlag"==this.name)flagType=3;else if("midFlag"!=this.name)return void(this.isHeld=!1);this.targetSlot=this.getTargetSlot(player.team,this.sourceSlot);var cd=this.config._.find(_this.config.clientCooldowns,{name:this.name});if(cd.heldBy=player.mp,cd.src=this.sourceSlot,cd.target=this.targetSlot,this.visible=!1,this.isActive=!1,this.isHeld=!0,this.heldBy=player.mp,player.hasFlag=flagType,player.bubble&&(player.bubble=!1),this.config.server){for(var l=0;l<this.getplayers.allplayers.length;l++)this.getplayers.allplayers[l].instance&&this.getplayers.allplayers[l].instance.send("f.r."+player.mp+"|"+this.name+"|"+player.flagTakenAt);var cd=this.config._.find(_this.config.clientCooldowns,{name:_this.name});cd.heldBy=player.mp,cd.src=this.sourceSlot,cd.target=this.targetSlot;var evt=this.config._.find(_this.config.events,{id:"fc"});evt.flag=this,evt.doStart()}else{var data={};data.action="takeFlag",data.targetSlot=cd.target,data.flagName=this.name,data.playerName=player.playerName,data.playerTeam=player.team,(new game_toast).show(data)}}}},game_flag.prototype.typeToName=function(type){switch(type){case 0:return null;case 1:return"midFlag";case 2:return"redFlag";case 3:return"blueFlag"}},game_flag.prototype.slotFlag=function(player){var _this=this,clientFlag=_.find(_this.config.clientCooldowns,{name:_this.typeToName(player.hasFlag)});if(void 0!==clientFlag&&this.name==clientFlag.target){var flg=this.config._.find(_this.config.flagObjects,{name:clientFlag.name});if(player.hasFlag=0,flg.isActive=!1,flg.onCooldown=!0,flg.isHeld=!1,flg.sourceSlot=this.name,flg.targetSlot=this.getTargetSlot(player.team,this.sourceSlot),this.config.server){var evt=this.config._.find(_this.config.events,{id:"fc"});evt.doStop();var cd=this.config._.find(_this.config.events,{type:evt.TYPE_FLAG_SLOTTED_COOLDOWN}),flg=this.config._.find(_this.config.flagObjects,{name:clientFlag.name});cd.flag=flg,cd.doStart()}flg.x=this.x-this.width/2,flg.y=this.y-this.height/2;for(var l=0;l<this.getplayers.allplayers.length;l++)this.getplayers.allplayers[l].instance&&this.getplayers.allplayers[l].instance.send("f.a."+player.mp+"|"+this.name+"|"+flg.name);this.config.server||this.config.updateTerritory();var flagObj=this.config._.find(_this.config.flagObjects,{name:clientFlag.name});flagObj.reset(!0)}},game_flag.prototype.reset=function(success,game){var _this=this,msg=void 0;if(this.isHeld&&success===!1){msg={};var playerSource=_.find(_this.getplayers.allplayers,{mp:_this.heldBy});msg.playerName=playerSource.playerName;var opponent;playerSource.killedBy&&(opponent=this.config._.find(_this.getplayers.allplayers,{mp:playerSource.killedBy}),opponentName=opponent.playerName),playerSource.vuln?msg.action="carrierStunned":playerSource.killedBy?msg.action="carrierDied":playerSource.dying?msg.action="carrierSuicide":(""==this.timer||this.timer<=0)&&(msg.action="flagTimeout"),msg.playerTeam=playerSource.team,msg.sourceSlot=this.sourceSlot,msg.targetSlot=this.targetSlot,msg.flagName=this.name}if(void 0!=msg&&(msg=JSON.stringify(msg)),this.isHeld=!1,this.visible=!0,success)this.isActive=!1,this.onCooldown=!0;else if(this.isActive=!0,this.config.server){var fcEvent=_.find(_this.config.events,{type:2});fcEvent.doStop(),_.forEach(_this.getplayers.allplayers,function(ply){ply.instance&&ply.instance.send("f.c."+_this.name+"|"+_this.visible+"|"+msg)})}},game_flag.prototype.timeoutCooldown=function(){},game_flag.prototype.cooldownComplete=function(){this.onCooldownLength=15,this.onCooldown=!1,this.isActive=!0},game_flag.prototype.setCtx=function(ctx){if(this.ctx=ctx,"slot"==this.type&&this.ctx)switch(this.name){case"slot1":this.image=assets.flag_slot_1;break;case"slot2":this.image=assets.flag_slot_2;break;case"slot3":this.image=assets.flag_slot_3;break;case"slot4":this.image=assets.flag_slot_4;break;case"slot5":this.image=assets.flag_slot_5;break;case"slot6":this.image=assets.flag_slot_6;break;case"slot7":this.image=assets.flag_slot_7;break;case"slot8":this.image=assets.flag_slot_8;break;case"slot9":this.image=assets.flag_slot_9;break;case"slot10":this.image=assets.flag_slot_10}this.ctx&&"flag"==this.type&&("midFlag"==name?this.image=assets.flag_mid_r:"redFlag"==name?this.image=assets.flag_red_l:"blueFlag"==name&&(this.image=assets.flag_blue_r))},game_flag.prototype.draw=function(){this.image&&this.visible&&this.ctx.drawImage(this.image,this.x,this.y,this.width,this.height),this.onCooldown&&this.timer>0&&(this.ctx.font="18px Mirza",this.ctx.fillStyle="midFlag"==this.name?"#000":"#fff",this.ctx.textAlign="center",this.ctx.fillText(this.timer,this.x+25,this.y+30))},"undefined"!=typeof global&&(module.exports=game_flag),game_platform.prototype.state=1,game_platform.prototype.setter=function(data){null==this.spawn&&(this.spawn={},this.spawn.x=data.x,this.spawn.y=data.y,this.spawn.w=data.w,this.spawn.h=data.h),this.old.x=this.x,this.old.y=this.y,this.old.w=this.w,this.old.h=this.h,this.x=data.x,this.y=data.y,this.w=data.w,this.h=data.h},game_platform.prototype.getCoord=function(){var nw={x:Math.floor(this.x/64),y:Math.floor(this.y/64)},ne={x:Math.floor((this.x+this.w)/64),y:Math.floor(this.y/64)},sw={x:Math.floor(this.x/64),y:Math.floor((this.y+this.h)/64)},se={x:Math.floor((this.x+this.w)/64),y:Math.floor((this.y+this.h)/64)};return{nw:nw,ne:ne,sw:sw,se:se}},game_platform.prototype.hitGrid=function(){var tmd=this.game.tilemapData;if(null!=tmd){var c=this.getCoord();return{nw:tmd[c.nw.y]&&tmd[c.nw.y][c.nw.x]?{t:parseInt(tmd[c.nw.y][c.nw.x]),x:c.nw.x,y:c.nw.y}:0,ne:tmd[c.ne.y]&&tmd[c.ne.y][c.ne.x]?{t:parseInt(tmd[c.ne.y][c.ne.x]),x:c.ne.x,y:c.ne.y}:0,sw:tmd[c.sw.y]&&tmd[c.sw.y][c.sw.x]?{t:parseInt(tmd[c.sw.y][c.sw.x]),x:c.sw.x,y:c.sw.y}:0,se:tmd[c.se.y]&&tmd[c.se.y][c.se.x]?{t:parseInt(tmd[c.se.y][c.se.x]),x:c.se.x,y:c.se.y}:0}}},game_platform.prototype.check_collision=function(){for(var i=0;i<this.game.platforms.length;i++)this.game.platforms[i].id!=this.id&&this.x<this.game.platforms[i].x+this.game.platforms[i].w&&this.x+this.w>this.game.platforms[i].x&&this.y<this.game.platforms[i].y+this.game.platforms[i].h&&this.y+this.h>this.game.platforms[i].y&&this.state===this.STATE_FALLING&&(this.setState(this.STATE_DESTROYED),this.y=this.game.platforms[i].y-this.h-5);if(this.state===this.STATE_ROTATING)for(var j=0;j<this.game.allplayers.length;j++)if(this.game.allplayers[j].pos.x+this.game.allplayers[j].size.hx>this.x&&this.game.allplayers[j].pos.x<this.x+this.w&&this.game.allplayers[j].pos.y>this.y-this.w/2&&this.game.allplayers[j].pos.y<this.y+this.w/2){var adjust,pl=this.game.allplayers[j];adjust=pl.pos.x<this.x+this.w/2?2*(this.x+this.w/2-pl.pos.x):-(2*(pl.pos.x-(this.x+this.w/2))),pl.pos.x+=adjust,this.game.server||pl.mp!=this.game.players.self.mp||this.game.players.self.draw()}var h=this.hitGrid();void 0!==h&&(h.nw.t>0&&h.sw.t>0||h.ne.t>0&&h.se.t>0||h.nw.t>0||h.ne.t>0||(h.sw.t>0||h.se.t>0)&&this.setState(this.STATE_DESTROYED))},game_platform.prototype.setState=function(state){var was=this.state;this.state=state;var is=state;was!==this.STATE_ROTATING||is!==this.STATE_INTACT||this.game.server||(this.ctx.clearRect(this.x,this.y-this.w/2,this.w+10,this.w+40),this.r=0,this.draw())},game_platform.prototype.update=function(){switch(this.state){case this.STATE_SHAKING:var shake=5,sx=Math.floor(Math.random()*(2*shake)+1)-shake,sy=Math.floor(Math.random()*(2*shake)+1)-shake;this.setter({x:this.spawn.x+sx,y:this.spawn.y+sy,w:this.w,h:this.h});break;case this.STATE_DESTROYED:1!==this.status&&(setTimeout(this.timeoutDestroyed.bind(this),2e3),this.status=1);break;case this.STATE_FALLING:this.setter({x:this.x,y:this.y=this.y+2*this.game.world.gravity,w:this.w,h:this.h});break;case this.STATE_ROTATING:this.game.server&&(this.r+=9),this.r<181||(this.r=0,this.game.server?this.setState(this.STATE_INTACT):this.setState(this.STATE_INTACT));break;case this.STATE_REMOVED:}},game_platform.prototype.timeoutDestroyed=function(){this.setState(this.STATE_REMOVED),this.removeFromStage(!0)},game_platform.prototype.doRotate=function(){this.r=1,this.setState(this.STATE_ROTATING)},game_platform.prototype.doShake=function(postShakeState,triggerer){this.state===this.STATE_INTACT&&(this.triggerer=triggerer,this.setState(this.STATE_SHAKING),this.status=postShakeState,setTimeout(this.timeoutShaking.bind(this),2e3))},game_platform.prototype.timeoutShaking=function(){if(this.setState(this.status),this.status==this.STATE_FALLING)for(var i=0;i<this.game.allplayers.length;i++)this.game.allplayers[i].supportingPlatformId==this.id&&(this.game.allplayers[i].landed=0);switch(this.setter({x:this.spawn.x,y:this.spawn.y,w:this.w,h:this.h}),this.game.server||this.draw(),this.state){case this.STATE_FALLING:break;case this.STATE_DESTROYED:}},game_platform.prototype.removeFromStage=function(doRespawn){this.x=-1e3,this.y=-1e3,this.w=0,this.h=0,this.status=0,this.state=0,this.old={},this.game.server||this.draw(),doRespawn===!0&&setTimeout(this.timeoutRespawn.bind(this),5e3)},game_platform.prototype.timeoutRespawn=function(){this.setState(this.STATE_INTACT),this.x=this.spawn.x,this.y=this.spawn.y,this.w=this.spawn.w,this.h=this.spawn.h,this.game.server||this.draw()},game_platform.prototype.draw=function(){if(this.state===this.STATE_INTACT||this.state===this.STATE_FALLING||this.state===this.STATE_SHAKING){this.ctx.clearRect(this.old.x,this.old.y-this.h,this.old.w,this.old.h+this.h),this.ctx.drawImage(document.getElementById("plat-l"),this.x,this.y,64,64),this.ctx.drawImage(document.getElementById("plat-r"),this.x+this.w-64,this.y,64,64);for(var rest=(this.w-128)/64,i=0;i<rest;i++)this.ctx.drawImage(document.getElementById("plat-m"),this.x+64*(i+1),this.y,64,64)}else this.state===this.STATE_DESTROYED?this.ctx.clearRect(this.x,this.y-5,this.w,this.h+5):this.state==this.STATE_ROTATING&&(this.ctx.clearRect(this.x,this.y-this.w/2,this.w+10,this.w+40),this.ctx.save(),this.ctx.translate(this.x+this.w/2,this.y+this.h/2),this.ctx.rotate(this.r*this.TO_RADIANS),this.ctx.drawImage(document.getElementById("plat-rotate"),-(this.w/2),-(this.h/2),384,64),this.ctx.restore())},"undefined"!=typeof global&&(module.exports=game_platform),game_event.prototype.update=function(){var _this=this;if(this.dif=Math.floor(this.config.server_time-this.triggerOn),this.dif>=1){switch(this.type){case this.TYPE_FLAG_CARRIED_COOLDOWN:var mp=this.flag.heldBy;this.flag.isHeld=!1,this.flag.isActive=!0,this.flag.heldBy=null;var player=this.config._.find(_this.getplayers.allplayers,{mp:mp});player.hasFlag=0,this.state=this.STATE_STOPPED;break;case this.TYPE_FLAG_SLOTTED_COOLDOWN:var mp=this.flag.heldBy,player=this.config._.find(_this.getplayers.allplayers,{mp:mp});this.flag.isActive=!0,this.flag.heldBy=null,this.flag.onCooldown=!1,this.flag.targetSlot=this.flag.getTargetSlot(player.team,this.flag.sourceSlot);break;case this.TYPE_CHEST:for(var ct=0,availChests=[],i=0;i<this.config.chestSpawnPoints.length;i++)this.config.chestSpawnPoints[i].active===!0?ct++:availChests.push(this.config.chestSpawnPoints[i]);if(ct>3)return!1;this.spawn=this.shuffle(availChests)[0],this.spawn.active=!0,this.passive=this.shuffle(this.config.passives)[0]}return this.repeatable===!0?this.setRandomTriggerTime(5,15):this.state=this.STATE_STOPPED,!0}return(this.type===this.TYPE_FLAG_CARRIED_COOLDOWN||this.type===this.TYPE_FLAG_SLOTTED_COOLDOWN)&&(this.timer=Math.abs(Math.floor(this.config.server_time-this.triggerOn)),this.timer!=this.lastTimer&&(this.lastTimer=this.timer,!0))},game_event.prototype.setRandomTriggerTime=function(min,max){this.rangeMin=min,this.rangeMax=max;var rnd=Math.floor(Math.random()*(max-min+1))+min;this.triggeredAt=this.config.server_time?Math.floor(this.config.server_time):0,this.triggerOn=Math.floor(this.triggeredAt)+rnd},game_event.prototype.setCooldownTime=function(){var cd;this.type===this.TYPE_FLAG_CARRIED_COOLDOWN?cd=this.COOLDOWN_FLAG_CARRIED:this.type===this.TYPE_FLAG_SLOTTED_COOLDOWN&&(cd=this.COOLDOWN_FLAG_SLOTTED),this.triggeredAt=this.config.server_time?Math.floor(this.config.server_time):0,this.triggerOn=Math.floor(this.triggeredAt)+cd},game_event.prototype.doStart=function(){switch(this.type){case this.TYPE_FLAG_CARRIED_COOLDOWN:this.setCooldownTime();break;case this.TYPE_FLAG_SLOTTED_COOLDOWN:this.setCooldownTime()}this.running=!0,this.state=this.STATE_RUNNING},game_event.prototype.doStop=function(){this.running=!1,this.state=this.STATE_STOPPED},"undefined"!=typeof global&&(module.exports=game_event);var assets=require("./singleton.assets"),_=require("./node_modules/lodash/lodash.min");game_chest.prototype.doTake=function(player){var _this=this;if(this.taken!==!0){switch(this.taken=!0,this.takenBy=player.mp,_.forEach(_this.getplayers.allplayers,function(ply){ply.instance&&ply.mp!=player.mp&&"hp"!=ply.mp&&ply.instance.send("c.t."+_this.id+"|"+player.mp)}),this.type){case 1:player.setPassive(this.data);break;case 2:player.setPassive(this.data)}_.forEach(this.config.chestSpawnPoints,function(spawn,key){parseInt(spawn.x)===_this.x&&parseInt(spawn.y)===_this.y&&(spawn.active=!1)}),this.opening=!0,setTimeout(this.timeoutOpened.bind(this),750)}},game_chest.prototype.timeoutOpened=function(){this.doRemove()},game_chest.prototype.doRemove=function(player){var _this=this;_.pull(this.config.chests,this),_.forEach(_this.getplayers.allplayers,function(ply){ply.instance&&ply.mp!=_this.takenBy&&"hp"!=ply.mp&&ply.instance.send("c.r."+_this.id+"|"+_this.takenBy)})},game_chest.prototype.update=function(){},game_chest.prototype.draw=function(){this.opening===!0?this.ctx.drawImage(assets.evt_chestopen,this.x,this.y,this.width,this.height):this.ctx.drawImage(assets.evt_chestclosed,this.x,this.y,this.width,this.height)},"undefined"!=typeof global&&(module.exports=game_chest),game_toast.prototype.show=function(data){data||(data={action:"takeFlag",playerName:"Jouster",playerTeam:0,flagName:"Mid Flag",targetSlot:"Placque #3"}),1===data.playerTeam?(data.playerTeam="#FF6961",data.otherTeam="#6ebee6"):(data.playerTeam="#6ebee6",data.otherTeam="#FF6961");var dir="over";switch(data.targetSlot){case"slot1":case"slot3":case"slot5":case"slot7":case"slot9":dir="down";break;case"slot2":case"slot4":case"slot6":case"slot8":case"slot10":dir="up";break;case"midSlot":case"slotRed":case"slotBlue":dir="over"}switch(data.action){case"takeFlag":this.toast.innerHTML="<font color='"+data.playerTeam+"'<b>"+data.playerName+"</b></font> siezed the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font>!<br>Rally "+dir+" to <font color='yellow'><b>"+this.getSlotLabel(data.targetSlot)+"</b></font>!";break;case"slotFlag":this.toast.innerHTML="<font color='"+data.playerTeam+"'<b>"+data.playerName+"</b></font> planted the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font><br> "+dir+" at <font color='yellow'><b>"+this.getSlotLabel(data.targetSlot)+"</b></font>!";break;case"carrierDied":this.toast.innerHTML="Your teammate <font color='"+data.otherTeam+"'<b>"+data.opponentName+"</b></font> waylaid the flagcarrier! <font color='"+data.playerTeam+"'<b>"+data.playerName+"</b></font> failed to advance the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font>!";break;case"carrierSuicide":this.toast.innerHTML="The flag-carrier <font color='"+data.playerTeam+"'<b>"+data.playerName+"</b></font> has perished, failing to advance the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font>!";break;case"carrierStunned":this.toast.innerHTML="The <font color='"+data.otherTeam+"'<b>flag carrier</b></font> dropped the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font>...";break;case"flagTimeout":this.toast.innerHTML="The <font color='"+data.otherTeam+"'<b>flag carrier</b></font> failed to advance the <font color='#fff'><b>"+this.getFlagLabel(data.flagName)+"</b></font> in time.";break;case"flagReset":break;case"player5kills":break;case"player10kills":break;case"player20kills":break;case"player50kills":break;case"playerInCanvern":break;case"playerInDiamondChamber":break;case"playerGotDiamond":}this.toast.style.display="block",setTimeout(this.timeoutShown.bind(this),5e3)},game_toast.prototype.hide=function(){this.toast.style.display="none"},game_toast.prototype.timeoutShown=function(){this.hide()},game_toast.prototype.getFlagLabel=function(name){var label="none";return"midFlag"==name?label="Mid Flag":"redFlag"==name?label="Red Flag":"blueFlag"==name&&(label="Blue Flag"),label},game_toast.prototype.getSlotLabel=function(slot){var label="none";switch(slot){case"slotRed":label="Red Base Placque";break;case"slotBlue":label="Blue Base Placque";break;case"midSlot":label="Mid Placque";break;case"slot1":label="Placque #1";break;case"slot2":label="Placque #2";break;case"slot3":label="Placque #3";break;case"slot4":label="Placque #4";break;case"slot5":label="Placque #5";break;case"slot6":label="Placque #6";break;case"slot7":label="Placque #7";break;case"slot8":label="Placque #8";break;case"slot9":label="Placque #9";break;case"slot10":label="Placque #10"}return label},module.exports=game_toast;